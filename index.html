<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>IDEAL MEBEL</title>
    <style>
        :root{--bg:#0d0d0d;--card:#1a1a1a;--card2:#252525;--accent:#8B7355;--accent2:#A69076;--green:#4CAF50;--red:#ef5350;--yellow:#FFB74D;--text:#fff;--text2:#999;--border:#333}
        *{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
        html,body{height:100%;overflow:hidden}
        body{font-family:-apple-system,BlinkMacSystemFont,sans-serif;background:var(--bg);color:var(--text);position:fixed;width:100%}
        .app{display:flex;flex-direction:column;height:100%;padding-top:env(safe-area-inset-top);padding-bottom:env(safe-area-inset-bottom)}
        .header{background:linear-gradient(135deg,#2c2c2c,#1a1a1a);padding:16px 20px;text-align:center;border-bottom:1px solid var(--border);position:relative}
        .header h1{font-size:22px;font-weight:700;letter-spacing:2px}
        .header-sub{font-size:11px;color:var(--text2);margin-top:4px;display:flex;align-items:center;justify-content:center;gap:8px}
        .sync-dot{width:8px;height:8px;border-radius:50%}
        .sync-dot.online{background:var(--green)}.sync-dot.offline{background:var(--red)}.sync-dot.syncing{background:var(--yellow);animation:pulse 1s infinite}
        @keyframes pulse{0%,100%{opacity:1}50%{opacity:.5}}
        .header-actions{position:absolute;right:12px;top:50%;transform:translateY(-50%);display:flex;gap:8px}
        .header-btn{width:34px;height:34px;border-radius:10px;background:var(--card2);border:1px solid var(--border);color:#fff;font-size:15px;cursor:pointer}
        .content{flex:1;overflow-y:auto;-webkit-overflow-scrolling:touch}
        .container{padding:14px;max-width:600px;margin:0 auto}
        .nav{background:var(--card);display:flex;justify-content:space-around;padding:8px 4px;border-top:1px solid var(--border)}
        .nav-item{display:flex;flex-direction:column;align-items:center;gap:2px;color:var(--text2);font-size:9px;padding:6px 10px;border-radius:10px;cursor:pointer;border:none;background:none}
        .nav-item.active{color:var(--accent2);background:rgba(139,115,85,.15)}
        .nav-item span{font-size:22px}
        .panel{display:none}.panel.active{display:block}
        .card{background:var(--card);border-radius:16px;padding:14px;margin-bottom:12px;border:1px solid var(--border)}
        .card-title{font-size:13px;color:var(--text2);margin-bottom:12px}
        .form-group{margin-bottom:12px}
        .form-group label{display:block;font-size:11px;color:var(--text2);margin-bottom:5px}
        .form-row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
        input,select{width:100%;padding:12px;background:var(--card2);border:1px solid var(--border);border-radius:12px;color:var(--text);font-size:16px;outline:none;-webkit-appearance:none}
        .btn{width:100%;padding:14px;border:none;border-radius:12px;font-size:15px;font-weight:600;cursor:pointer}
        .btn-primary{background:linear-gradient(135deg,var(--accent),var(--accent2));color:#fff}
        .btn-secondary{background:var(--card2);color:var(--text);border:1px solid var(--border)}
        .btn-success{background:var(--green);color:#fff}
        .btn-danger{background:var(--red);color:#fff}
        .btn-row{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px}
        .summary-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:14px}
        .summary-card{background:var(--card);border-radius:14px;padding:12px;border:1px solid var(--border)}
        .summary-card .label{font-size:10px;color:var(--text2);margin-bottom:3px}
        .summary-card .value{font-size:18px;font-weight:700}
        .summary-card .value.income{color:var(--green)}
        .summary-card .value.expense{color:var(--red)}
        .summary-card .value.profit{color:var(--accent2)}
        .summary-card .value.assets{color:var(--yellow)}
        .list-item{background:var(--card);border-radius:12px;padding:12px;margin-bottom:8px;border:1px solid var(--border)}
        .list-item.archived{opacity:.6;border-style:dashed}
        .list-item.deleted{opacity:.4;border-color:var(--red)}
        .list-item .row{display:flex;justify-content:space-between;align-items:flex-start;gap:8px}
        .list-item .title{font-weight:600;font-size:14px}
        .list-item .subtitle{font-size:11px;color:var(--text2);margin-top:3px}
        .list-item .amount{font-weight:700;font-size:15px}
        .list-item .amount.income{color:var(--green)}
        .list-item .amount.expense{color:var(--red)}
        .list-item .author{font-size:10px;color:var(--accent2);margin-top:4px}
        .project-money{display:flex;gap:6px;margin:8px 0;flex-wrap:wrap}
        .money-box{padding:6px 10px;border-radius:8px;font-size:12px;font-weight:600}
        .money-box.white{background:#fff;color:#000}
        .money-box.yellow{background:var(--yellow);color:#000}
        .progress-bar{height:5px;background:var(--card2);border-radius:3px;margin-top:8px;overflow:hidden}
        .progress-bar .fill{height:100%;border-radius:3px;max-width:100%}
        .actions{display:flex;gap:5px;margin-top:8px;flex-wrap:wrap}
        .action-btn{padding:6px 10px;border:none;border-radius:8px;font-size:11px;cursor:pointer;background:var(--card2);color:var(--text);border:1px solid var(--border)}
        .action-btn.danger{color:var(--red)}
        .action-btn.success{color:var(--green)}
        .tabs{display:flex;gap:6px;margin-bottom:14px;overflow-x:auto}
        .tab-btn{padding:8px 12px;background:var(--card);border:1px solid var(--border);border-radius:20px;color:var(--text2);font-size:11px;cursor:pointer;white-space:nowrap}
        .tab-btn.active{background:var(--accent);color:#fff;border-color:var(--accent)}
        .period-tabs{display:flex;gap:6px;margin-bottom:14px}
        .period-btn{flex:1;padding:10px;background:var(--card);border:1px solid var(--border);border-radius:12px;color:var(--text2);font-size:11px;cursor:pointer;text-align:center}
        .period-btn.active{background:var(--accent);color:#fff;border-color:var(--accent)}
        .stages{display:flex;gap:3px;margin-top:8px;flex-wrap:wrap}
        .stage{padding:4px 8px;background:var(--card2);border-radius:6px;font-size:9px;color:var(--text2);cursor:pointer}
        .stage.active{background:var(--accent);color:#fff}
        .stage.done{background:var(--green);color:#fff}
        .quick-actions{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-bottom:14px}
        .quick-btn{display:flex;flex-direction:column;align-items:center;gap:4px;padding:12px 6px;background:var(--card);border:1px solid var(--border);border-radius:12px;color:var(--text);font-size:10px;cursor:pointer}
        .quick-btn span{font-size:22px}
        .toast{position:fixed;bottom:100px;left:50%;transform:translateX(-50%);background:var(--card);padding:12px 20px;border-radius:12px;display:none;z-index:300;border:1px solid var(--border)}
        .modal{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.9);z-index:200;align-items:flex-end}
        .modal.active{display:flex}
        .modal#modalPhoto{align-items:center;justify-content:center}
        .modal-content{background:var(--card);border-radius:20px 20px 0 0;padding:18px;padding-bottom:calc(18px + env(safe-area-inset-bottom));width:100%;max-height:85vh;overflow-y:auto}
        .modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
        .modal-title{font-size:17px;font-weight:600}
        .modal-close{width:32px;height:32px;border-radius:50%;background:var(--card2);border:1px solid var(--border);color:var(--text);font-size:18px;cursor:pointer}
        .photo-preview{width:100%;max-height:100px;object-fit:cover;border-radius:10px;margin-top:8px;display:none}
        .photo-btn{display:flex;align-items:center;justify-content:center;gap:6px;padding:12px;background:var(--card2);border:2px dashed var(--border);border-radius:10px;color:var(--text2);cursor:pointer}
        .photo-thumb{height:40px;border-radius:6px;margin-top:6px;cursor:pointer}
        .empty{text-align:center;padding:30px;color:var(--text2)}
        .empty span{font-size:40px;display:block;margin-bottom:10px}
        .profit-box{background:linear-gradient(135deg,var(--card2),var(--card));border:2px solid var(--accent);border-radius:16px;padding:16px;margin-bottom:14px;text-align:center}
        .profit-box .big-value{font-size:28px;font-weight:700}
        .profit-box .label{font-size:11px;color:var(--text2);margin-bottom:4px}
        .contact-btns{display:flex;gap:8px;margin-top:10px}
        .contact-btn{flex:1;padding:10px;border-radius:10px;border:none;font-size:12px;cursor:pointer;text-decoration:none;text-align:center}
        .contact-btn.whatsapp{background:#25D366;color:#fff}
        .contact-btn.phone{background:var(--accent);color:#fff}
    </style>
</head>
<body>
<div class="app">
    <div class="header">
        <h1>IDEAL MEBEL</h1>
        <div class="header-sub"><span class="sync-dot offline" id="syncDot"></span><span id="syncStatus">–ó–∞–≥—Ä—É–∑–∫–∞...</span></div>
        <div class="header-actions"><button class="header-btn" onclick="manualSync()">üîÑ</button><button class="header-btn" onclick="openSettings()">‚öôÔ∏è</button></div>
    </div>
    <div class="content">
        <div class="container">
            <!-- –ì–õ–ê–í–ù–ê–Ø -->
            <div id="home" class="panel active">
                <div class="period-tabs">
                    <button class="period-btn active" onclick="setPeriod('all')">–í—Å—ë</button>
                    <button class="period-btn" onclick="setPeriod('year')">–ì–æ–¥</button>
                    <button class="period-btn" onclick="setPeriod('month')">–ú–µ—Å</button>
                    <button class="period-btn" onclick="setPeriod('week')">–ù–µ–¥</button>
                    <button class="period-btn" onclick="setPeriod('custom')">üìÖ</button>
                </div>
                <div id="customPeriod" style="display:none;margin-bottom:14px">
                    <div style="display:flex;gap:8px">
                        <div style="flex:1"><label style="font-size:11px;color:var(--text2)">–°</label><input type="date" id="periodFrom" onchange="applyCustomPeriod()"></div>
                        <div style="flex:1"><label style="font-size:11px;color:var(--text2)">–ü–æ</label><input type="date" id="periodTo" onchange="applyCustomPeriod()"></div>
                    </div>
                </div>
                <div class="profit-box"><div class="label">üíµ –°–í–û–ë–û–î–ù–´–ï –î–ï–ù–¨–ì–ò</div><div class="big-value income" id="homeFree">0 ‚ÇΩ</div></div>
                <div class="summary-grid">
                    <div class="summary-card"><div class="label">üí∞ –î–æ—Ö–æ–¥—ã</div><div class="value income" id="homeIncome">0 ‚ÇΩ</div></div>
                    <div class="summary-card"><div class="label">üí∏ –†–∞—Å—Ö–æ–¥—ã</div><div class="value expense" id="homeExpense">0 ‚ÇΩ</div></div>
                    <div class="summary-card"><div class="label">üìä –ü—Ä–∏–±—ã–ª—å</div><div class="value profit" id="homeProfit">0 ‚ÇΩ</div></div>
                    <div class="summary-card"><div class="label">üì¶ –ù–∞ —Å–∫–ª–∞–¥–µ</div><div class="value assets" id="homeAssets">0 ‚ÇΩ</div></div>
                </div>
                <div class="quick-actions">
                    <button class="quick-btn" onclick="showPanel('income')"><span>üí∞</span>–î–æ—Ö–æ–¥</button>
                    <button class="quick-btn" onclick="showPanel('expense')"><span>üí∏</span>–†–∞—Å—Ö–æ–¥</button>
                    <button class="quick-btn" onclick="newProject()"><span>üìã</span>–ü—Ä–æ–µ–∫—Ç</button>
                    <button class="quick-btn" onclick="openAddAsset()"><span>üì¶</span>–°–∫–ª–∞–¥</button>
                </div>
                <div class="card"><div class="card-title">üìÅ –†–∞—Å—Ö–æ–¥—ã –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º</div><div id="catStats"></div></div>
                <div class="card"><div class="card-title">üìà –ü–æ—Å–ª–µ–¥–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏</div><div id="recentOps"></div></div>
            </div>
            <!-- –ü–†–û–ï–ö–¢–´ -->
            <div id="projects" class="panel">
                <div class="tabs" id="projectsTabs">
                    <button class="tab-btn active" onclick="setProjFilter('active')">–í —Ä–∞–±–æ—Ç–µ</button>
                    <button class="tab-btn" onclick="setProjFilter('done')">–ó–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–µ</button>
                    <button class="tab-btn" onclick="setProjFilter('archive')">–ê—Ä—Ö–∏–≤</button>
                    <button class="tab-btn" onclick="setProjFilter('deleted')">–£–¥–∞–ª—ë–Ω–Ω—ã–µ</button>
                </div>
                <button class="btn btn-primary" onclick="newProject()" style="margin-bottom:14px">‚ûï –ù–æ–≤—ã–π –ø—Ä–æ–µ–∫—Ç</button>
                <div id="projectsList"></div>
            </div>
            <!-- –î–û–•–û–î–´ -->
            <div id="income" class="panel">
                <div class="card">
                    <div class="card-title">üí∞ –ó–∞–ø–∏—Å–∞—Ç—å –¥–æ—Ö–æ–¥</div>
                    <div class="form-group"><label>–ö—Ç–æ –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç</label><input type="text" id="incomeAuthor"></div>
                    <div class="form-group"><label>–ü—Ä–æ–µ–∫—Ç</label><select id="incomeProject"></select></div>
                    <div class="form-group"><label>–°—É–º–º–∞ (‚ÇΩ)</label><input type="number" id="incomeAmount" inputmode="decimal"></div>
                    <div class="form-row">
                        <div class="form-group"><label>–¢–∏–ø</label><select id="incomeType"><option>–ü—Ä–µ–¥–æ–ø–ª–∞—Ç–∞</option><option>–ß–∞—Å—Ç–∏—á–Ω–∞—è</option><option>–§–∏–Ω–∞–ª—å–Ω–∞—è</option><option>–§–∏—Ä–º–∞</option></select></div>
                        <div class="form-group"><label>–°–ø–æ—Å–æ–±</label><select id="incomeMethod"><option>–ù–∞–ª–∏—á–Ω—ã–µ</option><option>–ë–µ–∑–Ω–∞–ª</option><option>–ü–µ—Ä–µ–≤–æ–¥</option></select></div>
                    </div>
                    <div class="form-group"><label>–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ</label><input type="text" id="incomeNote"></div>
                    <button class="btn btn-success" onclick="saveIncome()">‚úÖ –ó–∞–ø–∏—Å–∞—Ç—å</button>
                </div>
                <div class="card">
                    <div class="card-title">üìã –ò—Å—Ç–æ—Ä–∏—è</div>
                    <div class="tabs" id="incomeTabs">
                        <button class="tab-btn active" onclick="setIncFilter('active')">–ê–∫—Ç—É–∞–ª—å–Ω—ã–µ</button>
                        <button class="tab-btn" onclick="setIncFilter('archived')">–ê—Ä—Ö–∏–≤</button>
                        <button class="tab-btn" onclick="setIncFilter('deleted')">–£–¥–∞–ª—ë–Ω–Ω—ã–µ</button>
                    </div>
                    <div id="incomeList"></div>
                </div>
            </div>
            <!-- –†–ê–°–•–û–î–´ -->
            <div id="expense" class="panel">
                <div class="card">
                    <div class="card-title">üí∏ –ó–∞–ø–∏—Å–∞—Ç—å —Ä–∞—Å—Ö–æ–¥</div>
                    <div class="form-group"><label>–ö—Ç–æ –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç</label><input type="text" id="expenseAuthor"></div>
                    <div class="form-group"><label>–ü—Ä–æ–µ–∫—Ç</label><select id="expenseProject"></select></div>
                    <div class="form-group"><label>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label><select id="expenseCategory"><option>–ú–∞–≥–∞–∑–∏–Ω—ã</option><option>–ó–∞–∫—É–ø –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤</option><option>–ê–º–æ—Ä—Ç–∏–∑–∞—Ü–∏—è</option><option>–£–ª—É—á—à–µ–Ω–∏–µ —Ü–µ—Ö–∞</option><option>–û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ</option><option>–î–æ—Å—Ç–∞–≤–∫–∞</option><option>–ë–µ–Ω–∑–∏–Ω</option><option>–†–µ–∫–ª–∞–º–∞</option><option>–ù–∞–ª–æ–≥–∏</option><option>–ê—Ä–µ–Ω–¥–∞</option><option>–í–æ–¥–æ–∫–∞–Ω–∞–ª</option><option>–≠–ª–µ–∫—Ç—Ä–æ—ç–Ω–µ—Ä–≥–∏—è</option><option>–£–≥–æ–ª—å</option><option>–ü—Ä–æ—á–∏–µ</option><option>–ó–ü –°–∞—à–∞</option><option>–ó–ü –†–æ–º–∞</option><option>–ó–ü –õ–µ—Ö–∞</option><option>–ó–ü –ê—Ä–∞</option><option>–ó–ü –ö–æ—Ä–æ–±–æ–≤</option><option>–§–∏—Ä–º–∞</option></select></div>
                    <div class="form-row">
                        <div class="form-group"><label>–°—É–º–º–∞ (‚ÇΩ)</label><input type="number" id="expenseAmount" inputmode="decimal"></div>
                        <div class="form-group"><label>–°–ø–æ—Å–æ–±</label><select id="expenseMethod"><option>–ù–∞–ª–∏—á–Ω—ã–µ</option><option>–ë–µ–∑–Ω–∞–ª</option><option>–ü–µ—Ä–µ–≤–æ–¥</option></select></div>
                    </div>
                    <div class="form-group"><label>–û–ø–∏—Å–∞–Ω–∏–µ</label><input type="text" id="expenseDesc"></div>
                    <div class="form-group"><label>–§–æ—Ç–æ</label><label class="photo-btn" for="expensePhoto">üì∑ –ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å —Ñ–æ—Ç–æ</label><input type="file" id="expensePhoto" accept="image/*" capture="environment" style="display:none" onchange="previewPhoto(this)"><img id="photoPreview" class="photo-preview"></div>
                    <button class="btn btn-danger" onclick="saveExpense()">üí∏ –ó–∞–ø–∏—Å–∞—Ç—å</button>
                </div>
                <div class="card">
                    <div class="card-title">üìã –ò—Å—Ç–æ—Ä–∏—è</div>
                    <div class="tabs" id="expenseTabs">
                        <button class="tab-btn active" onclick="setExpFilter('active')">–ê–∫—Ç—É–∞–ª—å–Ω—ã–µ</button>
                        <button class="tab-btn" onclick="setExpFilter('archived')">–ê—Ä—Ö–∏–≤</button>
                        <button class="tab-btn" onclick="setExpFilter('deleted')">–£–¥–∞–ª—ë–Ω–Ω—ã–µ</button>
                    </div>
                    <div id="expenseList"></div>
                </div>
            </div>
            <!-- –°–ö–õ–ê–î -->
            <div id="assets" class="panel">
                <div class="profit-box"><div class="label">üì¶ –ù–ê –°–ö–õ–ê–î–ï</div><div class="big-value assets" id="totalAssets">0 ‚ÇΩ</div></div>
                <button class="btn btn-primary" onclick="openAddAsset()" style="margin-bottom:10px">‚ûï –î–æ–±–∞–≤–∏—Ç—å –º–∞—Ç–µ—Ä–∏–∞–ª</button>
                <button class="btn btn-secondary" onclick="openUseAsset()" style="margin-bottom:14px">üì§ –°–ø–∏—Å–∞—Ç—å –Ω–∞ –ø—Ä–æ–µ–∫—Ç</button>
                <div id="assetsList"></div>
            </div>
        </div>
    </div>
    <nav class="nav">
        <button class="nav-item active" onclick="showPanel('home')"><span>üè†</span>–ì–ª–∞–≤–Ω–∞—è</button>
        <button class="nav-item" onclick="showPanel('projects')"><span>üìã</span>–ü—Ä–æ–µ–∫—Ç—ã</button>
        <button class="nav-item" onclick="showPanel('income')"><span>üí∞</span>–î–æ—Ö–æ–¥</button>
        <button class="nav-item" onclick="showPanel('expense')"><span>üí∏</span>–†–∞—Å—Ö–æ–¥</button>
        <button class="nav-item" onclick="showPanel('assets')"><span>üì¶</span>–°–∫–ª–∞–¥</button>
    </nav>
</div>
<div class="toast" id="toast"></div>
<!-- –ú–æ–¥–∞–ª–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞ -->
<div class="modal" id="modalProject"><div class="modal-content">
    <div class="modal-header"><div class="modal-title" id="projectModalTitle">‚ûï –ù–æ–≤—ã–π –ø—Ä–æ–µ–∫—Ç</div><button class="modal-close" onclick="closeModal('project')">‚úï</button></div>
    <input type="hidden" id="editProjectId">
    <div class="form-group"><label>–ö—Ç–æ —Å–æ–∑–¥–∞—ë—Ç</label><input type="text" id="projectAuthor"></div>
    <div class="form-group"><label>–ù–∞–∑–≤–∞–Ω–∏–µ</label><input type="text" id="projectName"></div>
    <div class="form-group"><label>–ö–ª–∏–µ–Ω—Ç</label><input type="text" id="projectClient"></div>
    <div class="form-group"><label>–ê–¥—Ä–µ—Å</label><input type="text" id="projectAddress"></div>
    <div class="form-group"><label>–¢–µ–ª–µ—Ñ–æ–Ω</label><input type="tel" id="projectPhone"></div>
    <div class="form-group"><label>–°—É–º–º–∞ –¥–æ–≥–æ–≤–æ—Ä–∞ (‚ÇΩ)</label><input type="number" id="projectSum" inputmode="decimal"></div>
    <div class="form-row">
        <div class="form-group"><label>–î–∞—Ç–∞ –¥–æ–≥–æ–≤–æ—Ä–∞</label><input type="date" id="projectDateStart"></div>
        <div class="form-group"><label>–î–µ–¥–ª–∞–π–Ω</label><input type="date" id="projectDeadline"></div>
    </div>
    <button class="btn btn-primary" onclick="saveProject()">‚úÖ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
</div></div>
<!-- –ú–æ–¥–∞–ª–∫–∞ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ -->
<div class="modal" id="modalView"><div class="modal-content">
    <div class="modal-header"><div class="modal-title" id="viewTitle"></div><button class="modal-close" onclick="closeModal('view')">‚úï</button></div>
    <div id="viewContent"></div>
</div></div>
<!-- –ú–æ–¥–∞–ª–∫–∞ –º–∞—Ç–µ—Ä–∏–∞–ª–∞ -->
<div class="modal" id="modalAsset"><div class="modal-content">
    <div class="modal-header"><div class="modal-title">‚ûï –î–æ–±–∞–≤–∏—Ç—å –º–∞—Ç–µ—Ä–∏–∞–ª</div><button class="modal-close" onclick="closeModal('asset')">‚úï</button></div>
    <div class="form-group"><label>–ö—Ç–æ –¥–æ–±–∞–≤–ª—è–µ—Ç</label><input type="text" id="assetAuthor"></div>
    <div class="form-group"><label>–ù–∞–∑–≤–∞–Ω–∏–µ</label><input type="text" id="newAssetName"></div>
    <div class="form-row">
        <div class="form-group"><label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</label><input type="number" id="newAssetQty" inputmode="decimal"></div>
        <div class="form-group"><label>–ï–¥–∏–Ω–∏—Ü–∞</label><select id="newAssetUnit"><option>—à—Ç</option><option>–º¬≤</option><option>–º.–ø.</option><option>–∫–≥</option><option>–ª</option><option>—É–ø</option></select></div>
    </div>
    <div class="form-group"><label>–û–±—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å (‚ÇΩ)</label><input type="number" id="newAssetCost" inputmode="decimal"></div>
    <button class="btn btn-primary" onclick="addAsset()">‚úÖ –î–æ–±–∞–≤–∏—Ç—å</button>
</div></div>
<!-- –ú–æ–¥–∞–ª–∫–∞ —Å–ø–∏—Å–∞–Ω–∏—è -->
<div class="modal" id="modalUse"><div class="modal-content">
    <div class="modal-header"><div class="modal-title">üì§ –°–ø–∏—Å–∞—Ç—å –º–∞—Ç–µ—Ä–∏–∞–ª</div><button class="modal-close" onclick="closeModal('use')">‚úï</button></div>
    <div class="form-group"><label>–ö—Ç–æ —Å–ø–∏—Å—ã–≤–∞–µ—Ç</label><input type="text" id="useAssetAuthor"></div>
    <div class="form-group"><label>–ú–∞—Ç–µ—Ä–∏–∞–ª</label><select id="useAssetSelect"></select></div>
    <div class="form-group"><label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</label><input type="number" id="useAssetQty" inputmode="decimal"></div>
    <div class="form-group"><label>–ù–∞ –ø—Ä–æ–µ–∫—Ç</label><select id="useAssetProject"></select></div>
    <button class="btn btn-primary" onclick="useAsset()">üì§ –°–ø–∏—Å–∞—Ç—å</button>
</div></div>
<!-- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ -->
<div class="modal" id="modalSettings"><div class="modal-content">
    <div class="modal-header"><div class="modal-title">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</div><button class="modal-close" onclick="closeModal('settings')">‚úï</button></div>
    <div class="card"><button class="btn btn-primary" onclick="manualSync()">üîÑ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Å–µ–π—á–∞—Å</button></div>
    <div class="card">
        <div class="card-title">üíæ –†–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è</div>
        <div class="btn-row">
            <button class="btn btn-secondary" onclick="exportBackup()">üíæ –°–∫–∞—á–∞—Ç—å</button>
            <button class="btn btn-secondary" onclick="document.getElementById('importFile').click()">üì§ –ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
        </div>
        <input type="file" id="importFile" accept=".json" style="display:none" onchange="importBackup(this)">
    </div>
</div></div>
<!-- –§–æ—Ç–æ -->
<div class="modal" id="modalPhoto" onclick="closeModal('photo')"><img id="modalPhotoImg" style="max-width:95%;max-height:90%;border-radius:12px"></div>

<script>
const API='https://script.google.com/macros/s/AKfycbwlmez3kvl2aq6oiDCbMRjBuwlyEVjkx0FNexmnU40A81JsMeI9fsmAResAoktYhr_0/exec';
let D={projects:[],income:[],expenses:[],assets:[]};
let projF='active', incF='active', expF='active', period='all', customFrom='', customTo='', syncing=false, photo=null;

// === –°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–Ø ===
function merge(local, cloud) {
    const map = new Map();
    (cloud||[]).forEach(item => { if(item && item.id) map.set(item.id, item); });
    (local||[]).forEach(item => {
        if(!item || !item.id) return;
        const ex = map.get(item.id);
        if(!ex) { map.set(item.id, item); }
        else if((item._deleted || item._archived) && !(ex._deleted || ex._archived)) { map.set(item.id, item); }
        else if((item.ts||'') > (ex.ts||'')) { map.set(item.id, item); }
    });
    return Array.from(map.values());
}

async function loadCloud() {
    if(syncing) return;
    syncing = true;
    setSync('syncing', '...');
    try {
        const r = await fetch(API + '?action=getData&t=' + Date.now());
        const c = await r.json();
        if(c && c.projects !== undefined) {
            D.projects = merge(D.projects, c.projects);
            D.income = merge(D.income, c.income);
            D.expenses = merge(D.expenses, c.expenses);
            D.assets = merge(D.assets, c.assets);
            fix(); saveLocal(); render();
            setSync('online', 'OK');
        } else {
            setSync('offline', '–û—à–∏–±–∫–∞');
        }
    } catch(e) {
        console.error(e);
        setSync('offline', '–û—Ñ–ª–∞–π–Ω');
    }
    syncing = false;
}

async function saveCloud() {
    if(syncing) return false;
    syncing = true;
    setSync('syncing', '...');
    try {
        // –°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∂–∞–µ–º –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
        const r1 = await fetch(API + '?action=getData&t=' + Date.now());
        const c = await r1.json();
        if(c && c.projects !== undefined) {
            D.projects = merge(D.projects, c.projects);
            D.income = merge(D.income, c.income);
            D.expenses = merge(D.expenses, c.expenses);
            D.assets = merge(D.assets, c.assets);
        }
        fix();
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º
        const r2 = await fetch(API + '?action=saveData', { method: 'POST', body: JSON.stringify(D) });
        const res = await r2.json();
        if(res.success) {
            saveLocal();
            setSync('online', 'OK');
            syncing = false;
            return true;
        }
    } catch(e) {
        console.error(e);
    }
    setSync('offline', '–û—à–∏–±–∫–∞');
    syncing = false;
    return false;
}

async function manualSync() { toast('üîÑ'); await loadCloud(); render(); toast('‚úÖ'); }
function saveLocal() { try { localStorage.setItem('IM19', JSON.stringify(D)); } catch(e) {} }
function loadLocal() { 
    try { 
        // –ü—Ä–æ–±—É–µ–º –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑ –Ω–æ–≤–æ–π –≤–µ—Ä—Å–∏–∏
        let s = localStorage.getItem('IM19'); 
        if(s) { D = JSON.parse(s); return; }
        
        // –ú–∏–≥—Ä–∞—Ü–∏—è —Å–æ —Å—Ç–∞—Ä—ã—Ö –≤–µ—Ä—Å–∏–π
        s = localStorage.getItem('IM18') || localStorage.getItem('IM17') || localStorage.getItem('IM16') || localStorage.getItem('IM15');
        if(s) { 
            D = JSON.parse(s); 
            saveLocal(); // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –Ω–æ–≤—ã–π –∫–ª—é—á
        }
    } catch(e) {} 
}

function fix() {
    D.projects = D.projects || [];
    D.income = D.income || [];
    D.expenses = D.expenses || [];
    D.assets = D.assets || [];
    D.projects.forEach(p => { p.sum = parseFloat(p.sum) || 0; p.stage = parseInt(p.stage) || 0; });
    D.income.forEach(i => { i.amount = parseFloat(i.amount) || 0; });
    D.expenses.forEach(e => { e.amount = parseFloat(e.amount) || 0; });
    D.assets.forEach(a => { a.qty = parseFloat(a.qty) || 0; a.pricePerUnit = parseFloat(a.pricePerUnit) || 0; a.totalCost = parseFloat(a.totalCost) || 0; });
    // –ü–µ—Ä–µ—Å—á—ë—Ç –æ–ø–ª–∞—á–µ–Ω–Ω–æ–≥–æ
    D.projects.forEach(p => {
        p.paid = D.income.filter(i => i.projectId === p.id && !i._archived && !i._deleted).reduce((s,i) => s + i.amount, 0);
    });
}

function setSync(s, t) {
    document.getElementById('syncDot').className = 'sync-dot ' + s;
    document.getElementById('syncStatus').textContent = t;
}

// === –£–¢–ò–õ–ò–¢–´ ===
function toast(m) { const t = document.getElementById('toast'); t.textContent = m; t.style.display = 'block'; setTimeout(() => t.style.display = 'none', 1500); }
function fmt(n) { return (Math.round(n) || 0).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ' ') + ' ‚ÇΩ'; }
function now() { return new Date().toISOString(); }
function today() { return now().split('T')[0]; }
function fmtD(d) { if(!d) return '‚Äî'; if(d.includes('T')) d = d.split('T')[0]; const p = d.split('-'); return p.length === 3 ? p[2] + '.' + p[1] + '.' + p[0] : d; }
function getDate(item) { return item.date || (item.ts ? item.ts.split('T')[0] : ''); }

function getPeriodStart() {
    if(period === 'custom') return customFrom || '2000-01-01';
    const d = new Date();
    if(period === 'week') d.setDate(d.getDate() - 7);
    else if(period === 'month') d.setMonth(d.getMonth() - 1);
    else if(period === 'year') d.setFullYear(d.getFullYear() - 1);
    else return '2000-01-01';
    return d.toISOString().split('T')[0];
}

function getPeriodEnd() {
    if(period === 'custom') return customTo || today();
    return today();
}

// === UI ===
function showPanel(name) {
    document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
    document.getElementById(name).classList.add('active');
    event.currentTarget.classList.add('active');
}

function openModal(name) { document.getElementById('modal' + name[0].toUpperCase() + name.slice(1)).classList.add('active'); }
function closeModal(name) { document.getElementById('modal' + name[0].toUpperCase() + name.slice(1)).classList.remove('active'); }
function openSettings() { openModal('settings'); }

function setPeriod(p) {
    period = p;
    document.querySelectorAll('.period-btn').forEach(b => b.classList.remove('active'));
    event.currentTarget.classList.add('active');
    
    const customDiv = document.getElementById('customPeriod');
    if(p === 'custom') {
        customDiv.style.display = 'block';
        // –£—Å—Ç–∞–Ω–æ–≤–∏–º –¥–∞—Ç—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –µ—Å–ª–∏ –ø—É—Å—Ç—ã–µ
        if(!document.getElementById('periodFrom').value) {
            const d = new Date();
            d.setMonth(d.getMonth() - 1);
            document.getElementById('periodFrom').value = d.toISOString().split('T')[0];
            document.getElementById('periodTo').value = today();
        }
    } else {
        customDiv.style.display = 'none';
    }
    renderHome();
}

function applyCustomPeriod() {
    customFrom = document.getElementById('periodFrom').value;
    customTo = document.getElementById('periodTo').value;
    renderHome();
}

function setProjFilter(f) {
    projF = f;
    document.querySelectorAll('#projectsTabs .tab-btn').forEach(b => b.classList.remove('active'));
    event.currentTarget.classList.add('active');
    renderProjects();
}

function setIncFilter(f) {
    incF = f;
    document.querySelectorAll('#incomeTabs .tab-btn').forEach(b => b.classList.remove('active'));
    event.currentTarget.classList.add('active');
    renderIncome();
}

function setExpFilter(f) {
    expF = f;
    document.querySelectorAll('#expenseTabs .tab-btn').forEach(b => b.classList.remove('active'));
    event.currentTarget.classList.add('active');
    renderExpenses();
}

// === –§–û–¢–û ===
function previewPhoto(inp) {
    if(!inp.files || !inp.files[0]) return;
    const reader = new FileReader();
    reader.onload = e => {
        const img = new Image();
        img.onload = () => {
            const canvas = document.createElement('canvas');
            let w = img.width, h = img.height;
            if(w > 200 || h > 200) { if(w > h) { h = h * 200 / w; w = 200; } else { w = w * 200 / h; h = 200; } }
            canvas.width = w; canvas.height = h;
            canvas.getContext('2d').drawImage(img, 0, 0, w, h);
            photo = canvas.toDataURL('image/jpeg', 0.25);
            document.getElementById('photoPreview').src = photo;
            document.getElementById('photoPreview').style.display = 'block';
        };
        img.src = e.target.result;
    };
    reader.readAsDataURL(inp.files[0]);
}

function viewPhoto(id) {
    const e = D.expenses.find(x => x.id === id);
    if(e && e.photo) {
        document.getElementById('modalPhotoImg').src = e.photo;
        openModal('photo');
    }
}

// === –ü–†–û–ï–ö–¢–´ ===
function newProject() {
    document.getElementById('editProjectId').value = '';
    document.getElementById('projectModalTitle').textContent = '‚ûï –ù–æ–≤—ã–π –ø—Ä–æ–µ–∫—Ç';
    ['projectAuthor', 'projectName', 'projectClient', 'projectAddress', 'projectPhone', 'projectSum', 'projectDeadline'].forEach(id => document.getElementById(id).value = '');
    document.getElementById('projectDateStart').value = today();
    openModal('project');
}

function editProject(id) {
    const p = D.projects.find(x => x.id === id);
    if(!p) return;
    document.getElementById('editProjectId').value = id;
    document.getElementById('projectModalTitle').textContent = '‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å';
    document.getElementById('projectAuthor').value = p.author || '';
    document.getElementById('projectName').value = p.name || '';
    document.getElementById('projectClient').value = p.client || '';
    document.getElementById('projectAddress').value = p.address || '';
    document.getElementById('projectPhone').value = p.phone || '';
    document.getElementById('projectSum').value = p.sum || '';
    document.getElementById('projectDateStart').value = p.dateStart || '';
    document.getElementById('projectDeadline').value = p.deadline || '';
    closeModal('view');
    openModal('project');
}

async function saveProject() {
    const editId = document.getElementById('editProjectId').value;
    const name = document.getElementById('projectName').value.trim();
    const sum = parseFloat(document.getElementById('projectSum').value) || 0;
    if(!name || !sum) return toast('‚ùå –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏ —Å—É–º–º—É');
    
    const data = {
        name,
        client: document.getElementById('projectClient').value.trim(),
        address: document.getElementById('projectAddress').value.trim(),
        phone: document.getElementById('projectPhone').value.trim(),
        sum,
        dateStart: document.getElementById('projectDateStart').value || today(),
        deadline: document.getElementById('projectDeadline').value || '',
        author: document.getElementById('projectAuthor').value.trim(),
        ts: now()
    };
    
    if(editId) {
        const p = D.projects.find(x => x.id === editId);
        if(p) Object.assign(p, data);
    } else {
        data.id = '–ü' + Date.now();
        data.paid = 0;
        data.status = 'active';
        data.stage = 0;
        D.projects.push(data);
    }
    
    if(await saveCloud()) { closeModal('project'); render(); toast('‚úÖ'); }
}

function viewProject(id) {
    const p = D.projects.find(x => x.id === id);
    if(!p) return toast('–ü—Ä–æ–µ–∫—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω');
    const tE = D.expenses.filter(e => e.projectId === id && !e._archived && !e._deleted).reduce((s,e) => s + e.amount, 0);
    const stages = ['–ó–∞–º–µ—Ä', '–î–∏–∑–∞–π–Ω', '–ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ', '–î–æ—Å—Ç–∞–≤–∫–∞', '–ú–æ–Ω—Ç–∞–∂', '–ì–æ—Ç–æ–≤–æ'];
    const phone = (p.phone || '').replace(/\D/g, '');
    
    document.getElementById('viewTitle').textContent = p.name;
    document.getElementById('viewContent').innerHTML = `
        <div class="list-item">
            <div>üë§ ${p.client || '‚Äî'}</div>
            ${p.address ? `<div>üìç ${p.address}</div>` : ''}
            <div>üìû ${p.phone || '‚Äî'}</div>
            <div>üìÖ ${fmtD(p.dateStart)} ‚Üí ${fmtD(p.deadline)}</div>
            ${p.author ? `<div class="author">–°–æ–∑–¥–∞–ª: ${p.author}</div>` : ''}
        </div>
        ${phone ? `<div class="contact-btns"><a href="https://wa.me/${phone}" class="contact-btn whatsapp">üí¨ WhatsApp</a><a href="tel:${phone}" class="contact-btn phone">üìû –ü–æ–∑–≤–æ–Ω–∏—Ç—å</a></div>` : ''}
        <div class="card" style="margin-top:12px">
            <div class="stages">${stages.map((s,i) => `<div class="stage ${i < p.stage ? 'done' : i === p.stage ? 'active' : ''}" onclick="setStage('${id}',${i})">${s}</div>`).join('')}</div>
        </div>
        <div class="summary-grid" style="margin-top:12px">
            <div class="summary-card"><div class="label">–î–æ–≥–æ–≤–æ—Ä</div><div class="value">${fmt(p.sum)}</div></div>
            <div class="summary-card"><div class="label">–û–ø–ª–∞—á–µ–Ω–æ</div><div class="value income">${fmt(p.paid)}</div></div>
            <div class="summary-card"><div class="label">–†–∞—Å—Ö–æ–¥—ã</div><div class="value expense">${fmt(tE)}</div></div>
            <div class="summary-card"><div class="label">–ü—Ä–∏–±—ã–ª—å</div><div class="value ${p.paid - tE >= 0 ? 'income' : 'expense'}">${fmt(p.paid - tE)}</div></div>
        </div>
        <div class="progress-bar"><div class="fill" style="width:${Math.min(100, p.sum ? p.paid / p.sum * 100 : 0)}%;background:var(--green)"></div></div>
        <div class="btn-row" style="margin-top:12px">
            <button class="btn btn-secondary" onclick="editProject('${id}')">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
            <button class="btn btn-secondary" onclick="setProjStatus('${id}','active')">‚ôªÔ∏è –í —Ä–∞–±–æ—Ç—É</button>
        </div>`;
    openModal('view');
}

async function setProjStatus(id, status) {
    const p = D.projects.find(x => x.id === id);
    if(p) {
        p.status = status;
        p._deleted = false;
        p.ts = now();
        if(await saveCloud()) { closeModal('view'); render(); toast('‚úÖ'); }
    }
}

async function deleteProject(id) {
    if(!confirm('–£–¥–∞–ª–∏—Ç—å –ø—Ä–æ–µ–∫—Ç?')) return;
    const p = D.projects.find(x => x.id === id);
    if(p) {
        p._deleted = true;
        p._deletedAt = now();
        p.ts = now();
        if(await saveCloud()) { render(); toast('üóë'); }
    }
}

async function setStage(id, stage) {
    const p = D.projects.find(x => x.id === id);
    if(p) {
        p.stage = stage;
        p.ts = now();
        if(await saveCloud()) viewProject(id);
    }
}

// === –î–û–•–û–î–´ ===
async function saveIncome() {
    const projectId = document.getElementById('incomeProject').value;
    const amount = parseFloat(document.getElementById('incomeAmount').value) || 0;
    if(!projectId || !amount) return toast('‚ùå –í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ–µ–∫—Ç –∏ —Å—É–º–º—É');
    
    D.income.push({
        id: '–î' + Date.now(),
        projectId,
        amount,
        type: document.getElementById('incomeType').value,
        method: document.getElementById('incomeMethod').value,
        note: document.getElementById('incomeNote').value,
        date: today(),
        author: document.getElementById('incomeAuthor').value.trim(),
        ts: now()
    });
    
    if(await saveCloud()) {
        document.getElementById('incomeAmount').value = '';
        document.getElementById('incomeNote').value = '';
        render();
        toast('‚úÖ');
    }
}

async function archiveIncome(id) {
    const who = prompt('–ö—Ç–æ –∞—Ä—Ö–∏–≤–∏—Ä—É–µ—Ç?');
    if(!who) return;
    const i = D.income.find(x => x.id === id);
    if(i) {
        i._archived = true;
        i._archivedBy = who;
        i._archivedAt = now();
        i.ts = now();
        if(await saveCloud()) { render(); toast('üì¶'); }
    }
}

async function deleteIncome(id) {
    if(!confirm('–£–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å?')) return;
    const i = D.income.find(x => x.id === id);
    if(i) {
        i._deleted = true;
        i._deletedAt = now();
        i.ts = now();
        if(await saveCloud()) { render(); toast('üóë'); }
    }
}

async function restoreIncome(id) {
    const i = D.income.find(x => x.id === id);
    if(i) {
        i._archived = false;
        i._deleted = false;
        i.ts = now();
        if(await saveCloud()) { render(); toast('‚ôªÔ∏è'); }
    }
}

// === –†–ê–°–•–û–î–´ ===
async function saveExpense() {
    const amount = parseFloat(document.getElementById('expenseAmount').value) || 0;
    if(!amount) return toast('‚ùå –£–∫–∞–∂–∏—Ç–µ —Å—É–º–º—É');
    
    D.expenses.push({
        id: '–†' + Date.now(),
        projectId: document.getElementById('expenseProject').value,
        category: document.getElementById('expenseCategory').value,
        amount,
        method: document.getElementById('expenseMethod').value,
        desc: document.getElementById('expenseDesc').value,
        photo,
        date: today(),
        author: document.getElementById('expenseAuthor').value.trim(),
        ts: now()
    });
    
    if(await saveCloud()) {
        document.getElementById('expenseAmount').value = '';
        document.getElementById('expenseDesc').value = '';
        document.getElementById('expensePhoto').value = '';
        document.getElementById('photoPreview').style.display = 'none';
        photo = null;
        render();
        toast('‚úÖ');
    }
}

async function archiveExpense(id) {
    const who = prompt('–ö—Ç–æ –∞—Ä—Ö–∏–≤–∏—Ä—É–µ—Ç?');
    if(!who) return;
    const e = D.expenses.find(x => x.id === id);
    if(e) {
        e._archived = true;
        e._archivedBy = who;
        e._archivedAt = now();
        e.ts = now();
        if(await saveCloud()) { render(); toast('üì¶'); }
    }
}

async function deleteExpense(id) {
    if(!confirm('–£–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å?')) return;
    const e = D.expenses.find(x => x.id === id);
    if(e) {
        e._deleted = true;
        e._deletedAt = now();
        e.ts = now();
        if(await saveCloud()) { render(); toast('üóë'); }
    }
}

async function restoreExpense(id) {
    const e = D.expenses.find(x => x.id === id);
    if(e) {
        e._archived = false;
        e._deleted = false;
        e.ts = now();
        if(await saveCloud()) { render(); toast('‚ôªÔ∏è'); }
    }
}

// === –°–ö–õ–ê–î ===
function openAddAsset() {
    ['assetAuthor', 'newAssetName', 'newAssetQty', 'newAssetCost'].forEach(id => document.getElementById(id).value = '');
    openModal('asset');
}

async function addAsset() {
    const name = document.getElementById('newAssetName').value.trim();
    const qty = parseFloat(document.getElementById('newAssetQty').value) || 0;
    const cost = parseFloat(document.getElementById('newAssetCost').value) || 0;
    if(!name || !qty || !cost) return toast('‚ùå –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è');
    
    const unit = document.getElementById('newAssetUnit').value;
    const existing = D.assets.find(a => a.name.toLowerCase() === name.toLowerCase() && a.unit === unit);
    
    if(existing) {
        existing.qty += qty;
        existing.totalCost += cost;
        existing.pricePerUnit = existing.totalCost / existing.qty;
        existing.ts = now();
    } else {
        D.assets.push({
            id: '–ê' + Date.now(),
            name, qty, unit,
            pricePerUnit: cost / qty,
            totalCost: cost,
            author: document.getElementById('assetAuthor').value.trim(),
            ts: now()
        });
    }
    
    if(await saveCloud()) { closeModal('asset'); render(); toast('‚úÖ'); }
}

function openUseAsset() {
    const assets = D.assets.filter(a => a.qty > 0);
    const projects = D.projects.filter(p => p.status === 'active');
    document.getElementById('useAssetSelect').innerHTML = assets.map(a => `<option value="${a.id}">${a.name} (${a.qty} ${a.unit})</option>`).join('') || '<option>–ù–µ—Ç –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤</option>';
    document.getElementById('useAssetProject').innerHTML = projects.map(p => `<option value="${p.id}">${p.name}</option>`).join('') || '<option>–ù–µ—Ç –ø—Ä–æ–µ–∫—Ç–æ–≤</option>';
    ['useAssetAuthor', 'useAssetQty'].forEach(id => document.getElementById(id).value = '');
    openModal('use');
}

async function useAsset() {
    const assetId = document.getElementById('useAssetSelect').value;
    const qty = parseFloat(document.getElementById('useAssetQty').value) || 0;
    const asset = D.assets.find(x => x.id === assetId);
    if(!asset || qty <= 0 || qty > asset.qty) return toast('‚ùå –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ');
    
    const cost = asset.pricePerUnit * qty;
    asset.qty -= qty;
    asset.totalCost = asset.qty * asset.pricePerUnit;
    asset.ts = now();
    
    D.expenses.push({
        id: '–†' + Date.now(),
        projectId: document.getElementById('useAssetProject').value,
        category: '–°–æ —Å–∫–ª–∞–¥–∞',
        amount: cost,
        desc: `${asset.name} x${qty} ${asset.unit}`,
        date: today(),
        author: document.getElementById('useAssetAuthor').value.trim(),
        ts: now()
    });
    
    if(await saveCloud()) { closeModal('use'); render(); toast('‚úÖ'); }
}

// === –†–ï–ù–î–ï–† ===
function render() {
    renderSelects();
    renderHome();
    renderProjects();
    renderIncome();
    renderExpenses();
    renderAssets();
}

function renderSelects() {
    const active = D.projects.filter(p => p.status === 'active' && !p._deleted);
    const opts = active.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
    document.getElementById('incomeProject').innerHTML = opts || '<option value="">–ù–µ—Ç –ø—Ä–æ–µ–∫—Ç–æ–≤</option>';
    document.getElementById('expenseProject').innerHTML = '<option value="–û–±—â–∏–µ">–û–±—â–∏–µ —Ä–∞—Å—Ö–æ–¥—ã</option>' + opts;
}

function renderHome() {
    const periodStart = getPeriodStart();
    const periodEnd = getPeriodEnd();
    
    // –§–∏–ª—å—Ç—Ä—É–µ–º –ø–æ –ø–µ—Ä–∏–æ–¥—É
    const activeIncome = D.income.filter(i => {
        if(i._archived || i._deleted) return false;
        if(period === 'all') return true; // –í—Å—ë –≤—Ä–µ–º—è - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å—ë
        const d = getDate(i);
        if(!d) return true; // –±–µ–∑ –¥–∞—Ç—ã - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º
        return d >= periodStart && d <= periodEnd;
    });
    
    const activeExpense = D.expenses.filter(e => {
        if(e._archived || e._deleted) return false;
        if(period === 'all') return true;
        const d = getDate(e);
        if(!d) return true;
        return d >= periodStart && d <= periodEnd;
    });
    
    const totalIncome = activeIncome.reduce((s, i) => s + i.amount, 0);
    const totalExpense = activeExpense.reduce((s, e) => s + e.amount, 0);
    const totalAssets = D.assets.reduce((s, a) => s + (a.totalCost || 0), 0);
    
    document.getElementById('homeIncome').textContent = fmt(totalIncome);
    document.getElementById('homeExpense').textContent = fmt(totalExpense);
    document.getElementById('homeProfit').textContent = fmt(totalIncome - totalExpense);
    document.getElementById('homeAssets').textContent = fmt(totalAssets);
    document.getElementById('homeFree').textContent = fmt(totalIncome - totalExpense - totalAssets);
    
    // –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ —Ä–∞—Å—Ö–æ–¥–æ–≤
    const cats = {};
    activeExpense.forEach(e => { cats[e.category] = (cats[e.category] || 0) + e.amount; });
    const sortedCats = Object.entries(cats).sort((a, b) => b[1] - a[1]).slice(0, 5);
    document.getElementById('catStats').innerHTML = sortedCats.length 
        ? sortedCats.map(([cat, sum]) => `
            <div class="list-item">
                <div class="row"><div class="title">${cat}</div><div class="amount expense">${fmt(sum)}</div></div>
                <div class="progress-bar"><div class="fill" style="width:${totalExpense ? Math.min(100, sum / totalExpense * 100) : 0}%;background:var(--red)"></div></div>
            </div>`).join('')
        : '<p style="color:var(--text2);text-align:center">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</p>';
    
    // –ü–æ—Å–ª–µ–¥–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏
    const allOps = [
        ...activeIncome.map(i => ({...i, _type: 'income'})),
        ...activeExpense.map(e => ({...e, _type: 'expense'}))
    ].sort((a, b) => (b.ts || '').localeCompare(a.ts || '')).slice(0, 5);
    
    document.getElementById('recentOps').innerHTML = allOps.length
        ? allOps.map(op => {
            if(op._type === 'income') {
                const proj = D.projects.find(p => p.id === op.projectId);
                return `<div class="list-item"><div class="row"><div><div class="title">${proj ? proj.name : op.projectId}</div><div class="subtitle">${fmtD(op.date)} ‚Ä¢ ${op.type}</div>${op.author ? `<div class="author">üë§ ${op.author}</div>` : ''}</div><div class="amount income">+${fmt(op.amount)}</div></div></div>`;
            } else {
                return `<div class="list-item"><div class="row"><div><div class="title">${op.category}</div><div class="subtitle">${fmtD(op.date)}${op.desc ? ' ‚Ä¢ ' + op.desc : ''}</div>${op.author ? `<div class="author">üë§ ${op.author}</div>` : ''}</div><div class="amount expense">-${fmt(op.amount)}</div></div></div>`;
            }
        }).join('')
        : '<div class="empty"><span>üì≠</span>–ü—É—Å—Ç–æ</div>';
}

function renderProjects() {
    let list;
    if(projF === 'deleted') {
        list = D.projects.filter(p => p._deleted);
    } else {
        list = D.projects.filter(p => p.status === projF && !p._deleted);
    }
    
    const stages = ['–ó–∞–º–µ—Ä', '–î–∏–∑–∞–π–Ω', '–ü—Ä–æ–∏–∑–≤.', '–î–æ—Å—Ç–∞–≤–∫–∞', '–ú–æ–Ω—Ç–∞–∂', '–ì–æ—Ç–æ–≤–æ'];
    
    document.getElementById('projectsList').innerHTML = list.length
        ? list.map(p => {
            const percent = p.sum ? Math.min(100, Math.round(p.paid / p.sum * 100)) : 0;
            const rest = p.sum - p.paid;
            const isDel = p._deleted;
            
            return `<div class="list-item ${isDel ? 'deleted' : ''}">
                <div class="row"><div class="title">${p.name}</div></div>
                <div class="subtitle">${p.client || '‚Äî'} ‚Ä¢ ${fmtD(p.dateStart)}</div>
                ${p.address ? `<div class="subtitle">üìç ${p.address}</div>` : ''}
                ${p.author ? `<div class="author">üë§ ${p.author}</div>` : ''}
                ${isDel ? `<div class="subtitle" style="color:var(--red)">üóë –£–¥–∞–ª—ë–Ω ${fmtD(p._deletedAt)}</div>` : `
                    <div class="project-money">
                        <div class="money-box white">üí∞ ${fmt(p.sum)}</div>
                        <div class="money-box white">‚úÖ ${fmt(p.paid)}</div>
                        <div class="money-box yellow">‚è≥ ${fmt(rest)}</div>
                    </div>
                    <div class="stages">${stages.map((s, i) => `<div class="stage ${i < (p.stage || 0) ? 'done' : i === (p.stage || 0) ? 'active' : ''}">${s}</div>`).join('')}</div>
                    <div class="progress-bar"><div class="fill" style="width:${percent}%;background:var(--green)"></div></div>
                `}
                <div class="actions">
                    ${isDel ? `<button class="action-btn success" onclick="setProjStatus('${p.id}','active')">‚ôªÔ∏è –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>` : `
                        <button class="action-btn" onclick="viewProject('${p.id}')">üëÅ</button>
                        <button class="action-btn" onclick="editProject('${p.id}')">‚úèÔ∏è</button>
                        ${p.status === 'active' ? `<button class="action-btn" onclick="setProjStatus('${p.id}','done')">‚úÖ</button>` : ''}
                        ${p.status === 'done' ? `<button class="action-btn" onclick="setProjStatus('${p.id}','active')">‚ôªÔ∏è</button><button class="action-btn" onclick="setProjStatus('${p.id}','archive')">üì¶</button>` : ''}
                        ${p.status === 'archive' ? `<button class="action-btn" onclick="setProjStatus('${p.id}','active')">‚ôªÔ∏è</button>` : ''}
                        <button class="action-btn danger" onclick="deleteProject('${p.id}')">üóë</button>
                    `}
                </div>
            </div>`;
        }).join('')
        : '<div class="empty"><span>üìã</span>–ù–µ—Ç –ø—Ä–æ–µ–∫—Ç–æ–≤</div>';
}

function renderIncome() {
    let list;
    if(incF === 'deleted') list = D.income.filter(i => i._deleted).sort((a, b) => (b._deletedAt || '').localeCompare(a._deletedAt || ''));
    else if(incF === 'archived') list = D.income.filter(i => i._archived && !i._deleted).sort((a, b) => (b._archivedAt || '').localeCompare(a._archivedAt || ''));
    else list = D.income.filter(i => !i._archived && !i._deleted).sort((a, b) => (b.ts || '').localeCompare(a.ts || ''));
    
    document.getElementById('incomeList').innerHTML = list.length
        ? list.map(i => {
            const proj = D.projects.find(p => p.id === i.projectId);
            const isDel = i._deleted, isArch = i._archived;
            return `<div class="list-item ${isDel ? 'deleted' : isArch ? 'archived' : ''}">
                <div class="row"><div><div class="title">${proj ? proj.name : i.projectId}</div><div class="subtitle">${fmtD(i.date)} ‚Ä¢ ${i.type} ‚Ä¢ ${i.method || ''}</div>${i.author ? `<div class="author">üë§ ${i.author}</div>` : ''}</div><div class="amount income">+${fmt(i.amount)}</div></div>
                ${i.note ? `<div class="subtitle">üí¨ ${i.note}</div>` : ''}
                ${isDel ? `<div class="subtitle" style="color:var(--red)">üóë –£–¥–∞–ª–µ–Ω–æ ${fmtD(i._deletedAt)}</div>` : ''}
                ${isArch && !isDel ? `<div class="subtitle" style="color:var(--text2)">üì¶ ${i._archivedBy || ''} ‚Ä¢ ${fmtD(i._archivedAt)}</div>` : ''}
                <div class="actions">
                    ${isDel || isArch ? `<button class="action-btn success" onclick="restoreIncome('${i.id}')">‚ôªÔ∏è</button>` : `
                        <button class="action-btn" onclick="archiveIncome('${i.id}')">üì¶</button>
                        <button class="action-btn danger" onclick="deleteIncome('${i.id}')">üóë</button>
                    `}
                </div>
            </div>`;
        }).join('')
        : '<div class="empty"><span>üì≠</span>–ü—É—Å—Ç–æ</div>';
}

function renderExpenses() {
    let list;
    if(expF === 'deleted') list = D.expenses.filter(e => e._deleted).sort((a, b) => (b._deletedAt || '').localeCompare(a._deletedAt || ''));
    else if(expF === 'archived') list = D.expenses.filter(e => e._archived && !e._deleted).sort((a, b) => (b._archivedAt || '').localeCompare(a._archivedAt || ''));
    else list = D.expenses.filter(e => !e._archived && !e._deleted).sort((a, b) => (b.ts || '').localeCompare(a.ts || ''));
    
    document.getElementById('expenseList').innerHTML = list.length
        ? list.map(e => {
            const isDel = e._deleted, isArch = e._archived;
            return `<div class="list-item ${isDel ? 'deleted' : isArch ? 'archived' : ''}">
                <div class="row"><div><div class="title">${e.category}</div><div class="subtitle">${fmtD(e.date)} ‚Ä¢ ${e.projectId} ‚Ä¢ ${e.method || ''}</div>${e.author ? `<div class="author">üë§ ${e.author}</div>` : ''}</div><div class="amount expense">-${fmt(e.amount)}</div></div>
                ${e.desc ? `<div class="subtitle">üìù ${e.desc}</div>` : ''}
                ${e.photo ? `<img src="${e.photo}" class="photo-thumb" onclick="viewPhoto('${e.id}')">` : ''}
                ${isDel ? `<div class="subtitle" style="color:var(--red)">üóë –£–¥–∞–ª–µ–Ω–æ ${fmtD(e._deletedAt)}</div>` : ''}
                ${isArch && !isDel ? `<div class="subtitle" style="color:var(--text2)">üì¶ ${e._archivedBy || ''} ‚Ä¢ ${fmtD(e._archivedAt)}</div>` : ''}
                <div class="actions">
                    ${isDel || isArch ? `<button class="action-btn success" onclick="restoreExpense('${e.id}')">‚ôªÔ∏è</button>` : `
                        <button class="action-btn" onclick="archiveExpense('${e.id}')">üì¶</button>
                        <button class="action-btn danger" onclick="deleteExpense('${e.id}')">üóë</button>
                    `}
                </div>
            </div>`;
        }).join('')
        : '<div class="empty"><span>üì≠</span>–ü—É—Å—Ç–æ</div>';
}

function renderAssets() {
    const activeAssets = D.assets.filter(a => a.qty > 0);
    document.getElementById('totalAssets').textContent = fmt(activeAssets.reduce((s, a) => s + (a.totalCost || 0), 0));
    document.getElementById('assetsList').innerHTML = activeAssets.length
        ? activeAssets.map(a => `
            <div class="list-item">
                <div class="row">
                    <div><div class="title">${a.name}</div><div class="subtitle">${fmt(a.pricePerUnit)} –∑–∞ ${a.unit}</div>${a.author ? `<div class="author">üë§ ${a.author}</div>` : ''}</div>
                    <div><div class="amount assets">${a.qty} ${a.unit}</div><div class="subtitle">${fmt(a.totalCost)}</div></div>
                </div>
            </div>`).join('')
        : '<div class="empty"><span>üì¶</span>–°–∫–ª–∞–¥ –ø—É—Å—Ç</div>';
}

// === –ë–≠–ö–ê–ü ===
function exportBackup() {
    const a = document.createElement('a');
    a.href = URL.createObjectURL(new Blob([JSON.stringify(D, null, 2)], {type: 'application/json'}));
    a.download = 'ideal_mebel_backup_' + today() + '.json';
    a.click();
    toast('üíæ –ë—ç–∫–∞–ø —Å–æ—Ö—Ä–∞–Ω—ë–Ω');
}

function importBackup(input) {
    if(!input.files || !input.files[0]) return;
    const reader = new FileReader();
    reader.onload = async e => {
        try {
            const data = JSON.parse(e.target.result);
            if(data.projects) {
                D = data;
                if(await saveCloud()) { render(); toast('‚úÖ –î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã'); }
            }
        } catch { toast('‚ùå –û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞'); }
    };
    reader.readAsText(input.files[0]);
    input.value = '';
}

// === –ó–ê–ü–£–°–ö ===
async function init() {
    loadLocal();
    fix();
    render();
    await loadCloud();
    setInterval(loadCloud, 10000);
}

init();
</script>
</body>
</html>
