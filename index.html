<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#1a1a1a">
    <title>IDEAL MEBEL</title>
    <style>
        :root{--bg:#0d0d0d;--card:#1a1a1a;--card2:#252525;--accent:#8B7355;--accent2:#A69076;--green:#4CAF50;--red:#ef5350;--yellow:#FFB74D;--text:#fff;--text2:#999;--border:#333}
        *{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
        html,body{height:100%;overflow:hidden}
        body{font-family:-apple-system,BlinkMacSystemFont,sans-serif;background:var(--bg);color:var(--text);position:fixed;width:100%}
        .app{display:flex;flex-direction:column;height:100%;padding-top:env(safe-area-inset-top);padding-bottom:env(safe-area-inset-bottom)}
        .header{background:linear-gradient(135deg,#2c2c2c,#1a1a1a);padding:16px 20px;text-align:center;border-bottom:1px solid var(--border);position:relative}
        .header h1{font-size:22px;font-weight:700;letter-spacing:2px}
        .header-sub{font-size:11px;color:var(--text2);margin-top:4px;display:flex;align-items:center;justify-content:center;gap:8px}
        .sync-dot{width:8px;height:8px;border-radius:50%}
        .sync-dot.online{background:var(--green)}.sync-dot.offline{background:var(--red)}.sync-dot.syncing{background:var(--yellow);animation:pulse 1s infinite}
        @keyframes pulse{0%,100%{opacity:1}50%{opacity:.5}}
        .header-actions{position:absolute;right:12px;top:50%;transform:translateY(-50%);display:flex;gap:8px}
        .header-btn{width:34px;height:34px;border-radius:10px;background:var(--card2);border:1px solid var(--border);color:#fff;font-size:15px;cursor:pointer}
        .content{flex:1;overflow-y:auto;-webkit-overflow-scrolling:touch}
        .container{padding:14px;max-width:600px;margin:0 auto}
        .nav{background:var(--card);display:flex;justify-content:space-around;padding:8px 4px;border-top:1px solid var(--border)}
        .nav-item{display:flex;flex-direction:column;align-items:center;gap:2px;color:var(--text2);font-size:9px;padding:6px 8px;border-radius:10px;cursor:pointer;border:none;background:none;min-width:50px}
        .nav-item.active{color:var(--accent2);background:rgba(139,115,85,.15)}
        .nav-item span{font-size:20px}
        .panel{display:none}.panel.active{display:block}
        .card{background:var(--card);border-radius:16px;padding:14px;margin-bottom:12px;border:1px solid var(--border)}
        .card-title{font-size:13px;color:var(--text2);margin-bottom:12px}
        .form-group{margin-bottom:12px}
        .form-group label{display:block;font-size:11px;color:var(--text2);margin-bottom:5px}
        .form-row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
        input,select{width:100%;padding:12px;background:var(--card2);border:1px solid var(--border);border-radius:12px;color:var(--text);font-size:16px;outline:none;-webkit-appearance:none}
        .btn{width:100%;padding:14px;border:none;border-radius:12px;font-size:15px;font-weight:600;cursor:pointer}
        .btn-primary{background:linear-gradient(135deg,var(--accent),var(--accent2));color:#fff}
        .btn-secondary{background:var(--card2);color:var(--text);border:1px solid var(--border)}
        .btn-success{background:var(--green);color:#fff}
        .btn-danger{background:var(--red);color:#fff}
        .btn-row{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px}
        .summary-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:14px}
        .summary-card{background:var(--card);border-radius:14px;padding:12px;border:1px solid var(--border)}
        .summary-card .label{font-size:10px;color:var(--text2);margin-bottom:3px}
        .summary-card .value{font-size:18px;font-weight:700}
        .summary-card .value.income{color:var(--green)}
        .summary-card .value.expense{color:var(--red)}
        .summary-card .value.profit{color:var(--accent2)}
        .summary-card .value.assets{color:var(--yellow)}
        .list-item{background:var(--card);border-radius:12px;padding:12px;margin-bottom:8px;border:1px solid var(--border)}
        .list-item.archived{opacity:.5;border-style:dashed}
        .list-item .row{display:flex;justify-content:space-between;align-items:flex-start;gap:8px}
        .list-item .title{font-weight:600;font-size:14px}
        .list-item .subtitle{font-size:11px;color:var(--text2);margin-top:3px}
        .list-item .amount{font-weight:700;font-size:15px}
        .list-item .amount.income{color:var(--green)}
        .list-item .amount.expense{color:var(--red)}
        .list-item .author{font-size:10px;color:var(--accent2);margin-top:4px}
        .badge{display:inline-block;padding:3px 8px;border-radius:15px;font-size:9px;font-weight:600;margin-top:6px;margin-right:4px}
        .badge-active{background:rgba(76,175,80,.2);color:var(--green)}
        .badge-done{background:rgba(139,115,85,.2);color:var(--accent2)}
        .badge-archive{background:rgba(153,153,153,.2);color:var(--text2)}
        .badge-margin{background:rgba(255,183,77,.2);color:var(--yellow)}
        .progress-bar{height:5px;background:var(--card2);border-radius:3px;margin-top:8px}
        .progress-bar .fill{height:100%;border-radius:3px}
        .actions{display:flex;gap:5px;margin-top:8px}
        .action-btn{padding:6px 12px;border:none;border-radius:8px;font-size:11px;cursor:pointer;background:var(--card2);color:var(--text);border:1px solid var(--border)}
        .action-btn.danger{color:var(--red)}
        .action-btn.success{color:var(--green)}
        .tabs{display:flex;gap:6px;margin-bottom:14px}
        .tab-btn{padding:8px 14px;background:var(--card);border:1px solid var(--border);border-radius:20px;color:var(--text2);font-size:12px;cursor:pointer}
        .tab-btn.active{background:var(--accent);color:#fff;border-color:var(--accent)}
        .stages{display:flex;gap:3px;margin-top:8px;flex-wrap:wrap}
        .stage{padding:4px 8px;background:var(--card2);border-radius:6px;font-size:9px;color:var(--text2);cursor:pointer}
        .stage.active{background:var(--accent);color:#fff}
        .stage.done{background:var(--green);color:#fff}
        .quick-actions{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-bottom:14px}
        .quick-btn{display:flex;flex-direction:column;align-items:center;gap:4px;padding:12px 6px;background:var(--card);border:1px solid var(--border);border-radius:12px;color:var(--text);font-size:10px;cursor:pointer}
        .quick-btn span{font-size:22px}
        .toast{position:fixed;bottom:100px;left:50%;transform:translateX(-50%);background:var(--card);padding:12px 20px;border-radius:12px;display:none;z-index:300;border:1px solid var(--border)}
        .modal{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.9);z-index:200;align-items:flex-end}
        .modal.active{display:flex}
        .modal#modalPhoto{align-items:center;justify-content:center}
        .modal-content{background:var(--card);border-radius:20px 20px 0 0;padding:18px;padding-bottom:calc(18px + env(safe-area-inset-bottom));width:100%;max-height:85vh;overflow-y:auto}
        .modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
        .modal-title{font-size:17px;font-weight:600}
        .modal-close{width:32px;height:32px;border-radius:50%;background:var(--card2);border:1px solid var(--border);color:var(--text);font-size:18px;cursor:pointer}
        .photo-preview{width:100%;max-height:100px;object-fit:cover;border-radius:10px;margin-top:8px;display:none}
        .photo-btn{display:flex;align-items:center;justify-content:center;gap:6px;padding:12px;background:var(--card2);border:2px dashed var(--border);border-radius:10px;color:var(--text2);cursor:pointer}
        .photo-thumb{height:40px;border-radius:6px;margin-top:6px;cursor:pointer}
        .date-filter{display:flex;gap:8px;margin-bottom:14px}
        .date-filter .form-group{flex:1;margin-bottom:0}
        .empty{text-align:center;padding:30px;color:var(--text2)}
        .empty span{font-size:40px;display:block;margin-bottom:10px}
        .profit-box{background:linear-gradient(135deg,var(--card2),var(--card));border:2px solid var(--accent);border-radius:16px;padding:16px;margin-bottom:14px;text-align:center}
        .profit-box .big-value{font-size:28px;font-weight:700}
        .profit-box .label{font-size:11px;color:var(--text2);margin-bottom:4px}
        .contact-btns{display:flex;gap:8px;margin-top:10px}
        .contact-btn{flex:1;padding:10px;border-radius:10px;border:none;font-size:12px;cursor:pointer;text-decoration:none;text-align:center}
        .contact-btn.whatsapp{background:#25D366;color:#fff}
        .contact-btn.phone{background:var(--accent);color:#fff}
    </style>
</head>
<body>
<div class="app">
    <div class="header">
        <h1>IDEAL MEBEL</h1>
        <div class="header-sub"><span class="sync-dot offline" id="syncDot"></span><span id="syncStatus">–ó–∞–≥—Ä—É–∑–∫–∞...</span></div>
        <div class="header-actions"><button class="header-btn" onclick="manualSync()">üîÑ</button><button class="header-btn" onclick="openModal('settings')">‚öôÔ∏è</button></div>
    </div>
    <div class="content">
        <div class="container">
            <div id="home" class="panel active">
                <div class="profit-box"><div class="label">üíµ –°–í–û–ë–û–î–ù–´–ï –î–ï–ù–¨–ì–ò</div><div class="big-value income" id="homeFree">0 ‚ÇΩ</div></div>
                <div class="summary-grid">
                    <div class="summary-card"><div class="label">üí∞ –î–æ—Ö–æ–¥—ã</div><div class="value income" id="homeIncome">0 ‚ÇΩ</div></div>
                    <div class="summary-card"><div class="label">üí∏ –†–∞—Å—Ö–æ–¥—ã</div><div class="value expense" id="homeExpense">0 ‚ÇΩ</div></div>
                    <div class="summary-card"><div class="label">üìä –ü—Ä–∏–±—ã–ª—å</div><div class="value profit" id="homeProfit">0 ‚ÇΩ</div></div>
                    <div class="summary-card"><div class="label">üì¶ –ù–∞ —Å–∫–ª–∞–¥–µ</div><div class="value assets" id="homeAssets">0 ‚ÇΩ</div></div>
                </div>
                <div class="quick-actions">
                    <button class="quick-btn" onclick="showPanel('income')"><span>üí∞</span>–î–æ—Ö–æ–¥</button>
                    <button class="quick-btn" onclick="showPanel('expense')"><span>üí∏</span>–†–∞—Å—Ö–æ–¥</button>
                    <button class="quick-btn" onclick="openModal('newProject')"><span>üìã</span>–ü—Ä–æ–µ–∫—Ç</button>
                    <button class="quick-btn" onclick="openModal('addAsset')"><span>üì¶</span>–°–∫–ª–∞–¥</button>
                </div>
                <div class="card"><div class="card-title">üìà –ü–æ—Å–ª–µ–¥–Ω–∏–µ</div><div id="recentOps"></div></div>
            </div>
            <div id="projects" class="panel">
                <div class="tabs" id="projectsTabs">
                    <button class="tab-btn active" onclick="filterProj('active',this)">–í —Ä–∞–±–æ—Ç–µ</button>
                    <button class="tab-btn" onclick="filterProj('done',this)">–ó–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–µ</button>
                    <button class="tab-btn" onclick="filterProj('archive',this)">–ê—Ä—Ö–∏–≤</button>
                </div>
                <button class="btn btn-primary" onclick="openModal('newProject')" style="margin-bottom:14px">‚ûï –ù–æ–≤—ã–π –ø—Ä–æ–µ–∫—Ç</button>
                <div id="projectsList"></div>
            </div>
            <div id="income" class="panel">
                <div class="card">
                    <div class="card-title">üí∞ –ó–∞–ø–∏—Å–∞—Ç—å –¥–æ—Ö–æ–¥</div>
                    <div class="form-group"><label>–ö—Ç–æ –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç</label><input type="text" id="incomeAuthor" placeholder="–ò–º—è"></div>
                    <div class="form-group"><label>–ü—Ä–æ–µ–∫—Ç</label><select id="incomeProject"></select></div>
                    <div class="form-group"><label>–°—É–º–º–∞ (‚ÇΩ)</label><input type="number" id="incomeAmount" inputmode="decimal"></div>
                    <div class="form-row">
                        <div class="form-group"><label>–¢–∏–ø</label><select id="incomeType"><option>–ü—Ä–µ–¥–æ–ø–ª–∞—Ç–∞</option><option>–ß–∞—Å—Ç–∏—á–Ω–∞—è</option><option>–§–∏–Ω–∞–ª—å–Ω–∞—è</option><option>–§–∏—Ä–º–∞</option></select></div>
                        <div class="form-group"><label>–°–ø–æ—Å–æ–±</label><select id="incomeMethod"><option>–ù–∞–ª–∏—á–Ω—ã–µ</option><option>–ë–µ–∑–Ω–∞–ª</option><option>–ü–µ—Ä–µ–≤–æ–¥</option></select></div>
                    </div>
                    <div class="form-group"><label>–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ</label><input type="text" id="incomeNote"></div>
                    <button class="btn btn-success" onclick="saveIncome()">‚úÖ –ó–∞–ø–∏—Å–∞—Ç—å</button>
                </div>
                <div class="card">
                    <div class="card-title">üìã –ò—Å—Ç–æ—Ä–∏—è <span id="incomeCount"></span></div>
                    <div class="tabs" id="incomeTabs">
                        <button class="tab-btn active" onclick="setIncomeFilter('active',this)">–ê–∫—Ç—É–∞–ª—å–Ω—ã–µ</button>
                        <button class="tab-btn" onclick="setIncomeFilter('archive',this)">–ê—Ä—Ö–∏–≤</button>
                    </div>
                    <div id="incomeList"></div>
                </div>
            </div>
            <div id="expense" class="panel">
                <div class="card">
                    <div class="card-title">üí∏ –ó–∞–ø–∏—Å–∞—Ç—å —Ä–∞—Å—Ö–æ–¥</div>
                    <div class="form-group"><label>–ö—Ç–æ –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç</label><input type="text" id="expenseAuthor" placeholder="–ò–º—è"></div>
                    <div class="form-group"><label>–ü—Ä–æ–µ–∫—Ç</label><select id="expenseProject"></select></div>
                    <div class="form-group"><label>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label><select id="expenseCategory"><option>–ú–∞–≥–∞–∑–∏–Ω—ã</option><option>–ó–∞–∫—É–ø –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤</option><option>–ê–º–æ—Ä—Ç–∏–∑–∞—Ü–∏—è –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è</option><option>–£–ª—É—á—à–µ–Ω–∏–µ —Ü–µ—Ö–∞</option><option>–û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ</option><option>–î–æ—Å—Ç–∞–≤–∫–∞</option><option>–ë–µ–Ω–∑–∏–Ω</option><option>–†–µ–∫–ª–∞–º–∞</option><option>–ù–∞–ª–æ–≥–∏</option><option>–ê—Ä–µ–Ω–¥–∞</option><option>–í–æ–¥–æ–∫–∞–Ω–∞–ª</option><option>–≠–ª–µ–∫—Ç—Ä–æ—ç–Ω–µ—Ä–≥–∏—è</option><option>–£–≥–æ–ª—å</option><option>–ü—Ä–æ—á–∏–µ</option><option>–ó–ü –°–∞—à–∞</option><option>–ó–ü –†–æ–º–∞</option><option>–ó–ü –õ–µ—Ö–∞</option><option>–ó–ü –ê—Ä–∞</option><option>–ó–ü –ö–æ—Ä–æ–±–æ–≤</option><option>–§–∏—Ä–º–∞</option></select></div>
                    <div class="form-row">
                        <div class="form-group"><label>–°—É–º–º–∞ (‚ÇΩ)</label><input type="number" id="expenseAmount" inputmode="decimal"></div>
                        <div class="form-group"><label>–°–ø–æ—Å–æ–±</label><select id="expenseMethod"><option>–ù–∞–ª–∏—á–Ω—ã–µ</option><option>–ë–µ–∑–Ω–∞–ª</option><option>–ü–µ—Ä–µ–≤–æ–¥</option></select></div>
                    </div>
                    <div class="form-group"><label>–û–ø–∏—Å–∞–Ω–∏–µ</label><input type="text" id="expenseDesc"></div>
                    <div class="form-group"><label>–§–æ—Ç–æ —á–µ–∫–∞</label><label class="photo-btn" for="expensePhoto">üì∑ –ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å</label><input type="file" id="expensePhoto" accept="image/*" capture="environment" style="display:none" onchange="previewPhoto(this)"><img id="photoPreview" class="photo-preview"></div>
                    <button class="btn btn-danger" onclick="saveExpense()">üí∏ –ó–∞–ø–∏—Å–∞—Ç—å</button>
                </div>
                <div class="card">
                    <div class="card-title">üìã –ò—Å—Ç–æ—Ä–∏—è <span id="expenseCount"></span></div>
                    <div class="tabs" id="expenseTabs">
                        <button class="tab-btn active" onclick="setExpenseFilter('active',this)">–ê–∫—Ç—É–∞–ª—å–Ω—ã–µ</button>
                        <button class="tab-btn" onclick="setExpenseFilter('archive',this)">–ê—Ä—Ö–∏–≤</button>
                    </div>
                    <div id="expenseList"></div>
                </div>
            </div>
            <div id="assets" class="panel">
                <div class="profit-box"><div class="label">üì¶ –ù–ê –°–ö–õ–ê–î–ï</div><div class="big-value assets" id="totalAssets">0 ‚ÇΩ</div></div>
                <button class="btn btn-primary" onclick="openModal('addAsset')" style="margin-bottom:10px">‚ûï –î–æ–±–∞–≤–∏—Ç—å</button>
                <button class="btn btn-secondary" onclick="openModal('useAsset')" style="margin-bottom:14px">üì§ –°–ø–∏—Å–∞—Ç—å</button>
                <div id="assetsList"></div>
            </div>
            <div id="analytics" class="panel">
                <div class="profit-box"><div class="label">üíµ –ß–ò–°–¢–ê–Ø –ü–†–ò–ë–´–õ–¨</div><div class="big-value income" id="statFree">0 ‚ÇΩ</div></div>
                <div class="date-filter"><div class="form-group"><label>–°</label><input type="date" id="dateFrom"></div><div class="form-group"><label>–ü–æ</label><input type="date" id="dateTo"></div></div>
                <div class="summary-grid">
                    <div class="summary-card"><div class="label">üí∞ –î–æ—Ö–æ–¥—ã</div><div class="value income" id="statIncome">0 ‚ÇΩ</div></div>
                    <div class="summary-card"><div class="label">üí∏ –†–∞—Å—Ö–æ–¥—ã</div><div class="value expense" id="statExpense">0 ‚ÇΩ</div></div>
                </div>
                <div class="card"><div class="card-title">üìÅ –ü–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º</div><div id="categoryStats"></div></div>
            </div>
        </div>
    </div>
    <nav class="nav">
        <button class="nav-item active" onclick="showPanel('home')"><span>üè†</span>–ì–ª–∞–≤–Ω–∞—è</button>
        <button class="nav-item" onclick="showPanel('projects')"><span>üìã</span>–ü—Ä–æ–µ–∫—Ç—ã</button>
        <button class="nav-item" onclick="showPanel('income')"><span>üí∞</span>–î–æ—Ö–æ–¥</button>
        <button class="nav-item" onclick="showPanel('expense')"><span>üí∏</span>–†–∞—Å—Ö–æ–¥</button>
        <button class="nav-item" onclick="showPanel('assets')"><span>üì¶</span>–°–∫–ª–∞–¥</button>
        <button class="nav-item" onclick="showPanel('analytics')"><span>üìä</span>–°–≤–æ–¥–∫–∞</button>
    </nav>
</div>
<div class="toast" id="toast"></div>
<div class="modal" id="modalNewProject"><div class="modal-content">
    <div class="modal-header"><div class="modal-title">‚ûï –ù–æ–≤—ã–π –ø—Ä–æ–µ–∫—Ç</div><button class="modal-close" onclick="closeModal('newProject')">‚úï</button></div>
    <div class="form-group"><label>–ö—Ç–æ —Å–æ–∑–¥–∞—ë—Ç</label><input type="text" id="projectAuthor" placeholder="–ò–º—è"></div>
    <div class="form-group"><label>–ù–∞–∑–≤–∞–Ω–∏–µ</label><input type="text" id="projectName"></div>
    <div class="form-row"><div class="form-group"><label>–ö–ª–∏–µ–Ω—Ç</label><input type="text" id="projectClient"></div><div class="form-group"><label>–¢–µ–ª–µ—Ñ–æ–Ω</label><input type="tel" id="projectPhone"></div></div>
    <div class="form-group"><label>–°—É–º–º–∞ (‚ÇΩ)</label><input type="number" id="projectSum" inputmode="decimal"></div>
    <div class="form-row"><div class="form-group"><label>–î–∞—Ç–∞ –¥–æ–≥–æ–≤–æ—Ä–∞</label><input type="date" id="projectDateStart"></div><div class="form-group"><label>–î–µ–¥–ª–∞–π–Ω</label><input type="date" id="projectDeadline"></div></div>
    <button class="btn btn-primary" onclick="saveProject()">‚úÖ –°–æ–∑–¥–∞—Ç—å</button>
</div></div>
<div class="modal" id="modalViewProject"><div class="modal-content">
    <div class="modal-header"><div class="modal-title" id="viewProjectTitle"></div><button class="modal-close" onclick="closeModal('viewProject')">‚úï</button></div>
    <div id="viewProjectContent"></div>
</div></div>
<div class="modal" id="modalAddAsset"><div class="modal-content">
    <div class="modal-header"><div class="modal-title">‚ûï –ú–∞—Ç–µ—Ä–∏–∞–ª</div><button class="modal-close" onclick="closeModal('addAsset')">‚úï</button></div>
    <div class="form-group"><label>–ö—Ç–æ –¥–æ–±–∞–≤–ª—è–µ—Ç</label><input type="text" id="assetAuthor" placeholder="–ò–º—è"></div>
    <div class="form-group"><label>–ù–∞–∑–≤–∞–Ω–∏–µ</label><input type="text" id="newAssetName"></div>
    <div class="form-row"><div class="form-group"><label>–ö–æ–ª-–≤–æ</label><input type="number" id="newAssetQty" inputmode="decimal"></div><div class="form-group"><label>–ï–¥.</label><select id="newAssetUnit"><option>—à—Ç</option><option>–º¬≤</option><option>–º.–ø.</option><option>–∫–≥</option><option>–ª</option><option>—É–ø</option></select></div></div>
    <div class="form-group"><label>–°—Ç–æ–∏–º–æ—Å—Ç—å (‚ÇΩ)</label><input type="number" id="newAssetCost" inputmode="decimal"></div>
    <button class="btn btn-primary" onclick="addAsset()">‚úÖ –î–æ–±–∞–≤–∏—Ç—å</button>
</div></div>
<div class="modal" id="modalUseAsset"><div class="modal-content">
    <div class="modal-header"><div class="modal-title">üì§ –°–ø–∏—Å–∞—Ç—å</div><button class="modal-close" onclick="closeModal('useAsset')">‚úï</button></div>
    <div class="form-group"><label>–ö—Ç–æ —Å–ø–∏—Å—ã–≤–∞–µ—Ç</label><input type="text" id="useAssetAuthor" placeholder="–ò–º—è"></div>
    <div class="form-group"><label>–ú–∞—Ç–µ—Ä–∏–∞–ª</label><select id="useAssetSelect"></select></div>
    <div class="form-group"><label>–ö–æ–ª-–≤–æ</label><input type="number" id="useAssetQty" inputmode="decimal"></div>
    <div class="form-group"><label>–ù–∞ –ø—Ä–æ–µ–∫—Ç</label><select id="useAssetProject"></select></div>
    <button class="btn btn-primary" onclick="useAsset()">üì§ –°–ø–∏—Å–∞—Ç—å</button>
</div></div>
<div class="modal" id="modalSettings"><div class="modal-content">
    <div class="modal-header"><div class="modal-title">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</div><button class="modal-close" onclick="closeModal('settings')">‚úï</button></div>
    <div class="card"><div class="card-title">üîÑ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è</div><p style="font-size:11px;color:var(--text2);margin-bottom:10px">–ê–≤—Ç–æ –∫–∞–∂–¥—ã–µ 10 —Å–µ–∫</p><button class="btn btn-primary" onclick="manualSync()">üîÑ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å</button></div>
    <div class="card"><div class="card-title">üíæ –ë—ç–∫–∞–ø</div><div class="btn-row"><button class="btn btn-secondary" onclick="exportBackup()">üíæ –°–∫–∞—á–∞—Ç—å</button><button class="btn btn-secondary" onclick="document.getElementById('importFile').click()">üì§ –ó–∞–≥—Ä—É–∑–∏—Ç—å</button></div><input type="file" id="importFile" accept=".json" style="display:none" onchange="importBackup(this)"></div>
</div></div>
<div class="modal" id="modalPhoto" onclick="closeModal('photo')"><img id="modalPhotoImg" style="max-width:95%;max-height:90%;border-radius:12px"></div>
<script>
const API='https://script.google.com/macros/s/AKfycbwlmez3kvl2aq6oiDCbMRjBuwlyEVjkx0FNexmnU40A81JsMeI9fsmAResAoktYhr_0/exec';
let D={projects:[],income:[],expenses:[],assets:[]};
let projF='active',incF='active',expF='active',syncing=false,photo=null;

// ============ –ú–ï–†–ñ –ü–û ID + TIMESTAMP ============
// –ü—Ä–∞–≤–∏–ª–∞:
// 1. –í—Å–µ —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ ID —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è (–Ω–∏—á–µ–≥–æ –Ω–µ —Ç–µ—Ä—è–µ—Ç—Å—è)
// 2. –ï—Å–ª–∏ ID —Å–æ–≤–ø–∞–¥–∞–µ—Ç ‚Äî –±–µ—Ä—ë–º –≤–µ—Ä—Å–∏—é —Å –±–æ–ª–µ–µ –ø–æ–∑–¥–Ω–∏–º ts
// 3. _archived=true –í–°–ï–ì–î–ê –ø–æ–±–µ–∂–¥–∞–µ—Ç (–¥–∞–∂–µ –µ—Å–ª–∏ ts —Å—Ç–∞—Ä—à–µ)

function merge(local, cloud){
    const map = new Map();
    
    // –î–æ–±–∞–≤–ª—è–µ–º –≤—Å–µ –∏–∑ –æ–±–ª–∞–∫–∞
    for(const item of (cloud||[])){
        if(item && item.id) map.set(item.id, item);
    }
    
    // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ
    for(const item of (local||[])){
        if(!item || !item.id) continue;
        
        const existing = map.get(item.id);
        
        if(!existing){
            // –ù–æ–≤–∞—è –∑–∞–ø–∏—Å—å ‚Äî –¥–æ–±–∞–≤–ª—è–µ–º
            map.set(item.id, item);
        } else {
            // –ó–∞–ø–∏—Å—å –µ—Å—Ç—å ‚Äî —Ä–µ—à–∞–µ–º –∫–∞–∫—É—é –æ—Å—Ç–∞–≤–∏—Ç—å
            
            // –ü—Ä–∞–≤–∏–ª–æ: –∞—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –í–°–ï–ì–î–ê –ø–æ–±–µ–∂–¥–∞–µ—Ç
            if(item._archived && !existing._archived){
                map.set(item.id, item);
            } else if(existing._archived && !item._archived){
                // –û–±–ª–∞—á–Ω–∞—è –∞—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞–Ω–∞ ‚Äî –æ—Å—Ç–∞–≤–ª—è–µ–º –µ—ë
            } else {
                // –û–±–µ –∞—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞–Ω—ã –∏–ª–∏ –æ–±–µ –Ω–µ—Ç ‚Äî —Å—Ä–∞–≤–Ω–∏–≤–∞–µ–º –ø–æ ts
                const localTs = item.ts || item.date || '0';
                const cloudTs = existing.ts || existing.date || '0';
                if(localTs > cloudTs){
                    map.set(item.id, item);
                }
            }
        }
    }
    
    return Array.from(map.values());
}

// ============ –°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–Ø ============
async function loadCloud(){
    if(syncing) return;
    syncing = true;
    setSync('syncing','–ó–∞–≥—Ä—É–∑–∫–∞...');
    
    try{
        const r = await fetch(API+'?action=getData&t='+Date.now());
        const cloud = await r.json();
        
        if(cloud && cloud.projects !== undefined){
            // –ú–µ—Ä–∂–∏–º –ª–æ–∫–∞–ª—å–Ω—ã–µ —Å –æ–±–ª–∞—á–Ω—ã–º–∏
            D.projects = merge(D.projects, cloud.projects);
            D.income = merge(D.income, cloud.income);
            D.expenses = merge(D.expenses, cloud.expenses);
            D.assets = merge(D.assets, cloud.assets);
            
            fix();
            saveLocal();
            render();
            setSync('online','–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ');
        } else {
            setSync('offline','–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏');
        }
    } catch(e){
        console.error('Load error:', e);
        setSync('offline','–û—Ñ–ª–∞–π–Ω');
    }
    syncing = false;
}

async function saveCloud(){
    if(syncing) return false;
    syncing = true;
    setSync('syncing','–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...');
    
    try{
        // 1. –ó–∞–≥—Ä—É–∂–∞–µ–º –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ –æ–±–ª–∞–∫–∞
        const r1 = await fetch(API+'?action=getData&t='+Date.now());
        const cloud = await r1.json();
        
        if(cloud && cloud.projects !== undefined){
            // 2. –ú–µ—Ä–∂–∏–º ‚Äî –Ω–∏ –æ–¥–Ω–∞ –∑–∞–ø–∏—Å—å –Ω–µ –ø–æ—Ç–µ—Ä—è–µ—Ç—Å—è
            D.projects = merge(D.projects, cloud.projects);
            D.income = merge(D.income, cloud.income);
            D.expenses = merge(D.expenses, cloud.expenses);
            D.assets = merge(D.assets, cloud.assets);
        }
        
        fix();
        
        // 3. –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ–±—ä–µ–¥–∏–Ω—ë–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
        const r2 = await fetch(API+'?action=saveData',{
            method:'POST',
            body:JSON.stringify(D)
        });
        const res = await r2.json();
        
        if(res.success){
            saveLocal();
            setSync('online','–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ');
            syncing = false;
            return true;
        }
    } catch(e){
        console.error('Save error:', e);
    }
    
    setSync('offline','–û—à–∏–±–∫–∞');
    syncing = false;
    return false;
}

async function manualSync(){
    toast('üîÑ');
    await loadCloud();
    render();
    toast('‚úÖ');
}

function saveLocal(){
    try{ localStorage.setItem('IM15', JSON.stringify(D)); } catch(e){}
}

function loadLocal(){
    try{
        const s = localStorage.getItem('IM15');
        if(s) D = JSON.parse(s);
    } catch(e){}
}

function fix(){
    D.projects = D.projects || [];
    D.income = D.income || [];
    D.expenses = D.expenses || [];
    D.assets = D.assets || [];
    
    D.projects.forEach(p=>{
        p.sum = parseFloat(p.sum)||0;
        p.stage = parseInt(p.stage)||0;
    });
    D.income.forEach(i=>{ i.amount = parseFloat(i.amount)||0; });
    D.expenses.forEach(e=>{ e.amount = parseFloat(e.amount)||0; });
    D.assets.forEach(a=>{
        a.qty = parseFloat(a.qty)||0;
        a.pricePerUnit = parseFloat(a.pricePerUnit)||0;
        a.totalCost = parseFloat(a.totalCost)||0;
    });
    
    // –ü–µ—Ä–µ—Å—á—ë—Ç paid –¥–ª—è –ø—Ä–æ–µ–∫—Ç–æ–≤
    D.projects.forEach(p=>{
        p.paid = D.income
            .filter(i => i.projectId === p.id && !i._archived)
            .reduce((s,i) => s + i.amount, 0);
    });
}

function setSync(s,t){
    document.getElementById('syncDot').className = 'sync-dot '+s;
    document.getElementById('syncStatus').textContent = t;
}

// ============ INIT ============
async function init(){
    loadLocal();
    fix();
    setDates();
    render();
    await loadCloud();
    setInterval(loadCloud, 10000);
}

function setDates(){
    const t = new Date(), m = new Date();
    m.setMonth(m.getMonth()-1);
    document.getElementById('dateTo').value = t.toISOString().split('T')[0];
    document.getElementById('dateFrom').value = m.toISOString().split('T')[0];
    document.getElementById('projectDateStart').value = t.toISOString().split('T')[0];
}

// ============ UI ============
function showPanel(n){
    document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));
    document.querySelectorAll('.nav-item').forEach(x=>x.classList.remove('active'));
    document.getElementById(n).classList.add('active');
    event.currentTarget.classList.add('active');
}
function openModal(n){
    document.getElementById('modal'+n[0].toUpperCase()+n.slice(1)).classList.add('active');
    if(n==='useAsset') fillAssetModal();
}
function closeModal(n){
    document.getElementById('modal'+n[0].toUpperCase()+n.slice(1)).classList.remove('active');
}
function toast(m){
    const t=document.getElementById('toast');
    t.textContent=m; t.style.display='block';
    setTimeout(()=>t.style.display='none',1500);
}
function fmt(n){ return (Math.round(n)||0).toString().replace(/\B(?=(\d{3})+(?!\d))/g,' ')+' ‚ÇΩ'; }
function now(){ return new Date().toISOString(); }
function today(){ return now().split('T')[0]; }
function fmtD(d){ if(!d)return'‚Äî'; const p=d.split('-'); return p.length===3?p[2]+'.'+p[1]+'.'+p[0]:d; }

// ============ PHOTO ============
function previewPhoto(inp){
    if(!inp.files||!inp.files[0]) return;
    const r = new FileReader();
    r.onload = e => {
        const img = new Image();
        img.onload = () => {
            const c = document.createElement('canvas');
            let w=img.width, h=img.height;
            if(w>200||h>200){ if(w>h){h=h*200/w;w=200}else{w=w*200/h;h=200} }
            c.width=w; c.height=h;
            c.getContext('2d').drawImage(img,0,0,w,h);
            photo = c.toDataURL('image/jpeg',0.25);
            document.getElementById('photoPreview').src = photo;
            document.getElementById('photoPreview').style.display = 'block';
        };
        img.src = e.target.result;
    };
    r.readAsDataURL(inp.files[0]);
}
function viewPhoto(id){
    const e = D.expenses.find(x=>x.id===id);
    if(e&&e.photo){
        document.getElementById('modalPhotoImg').src = e.photo;
        openModal('photo');
    }
}

// ============ PROJECTS ============
async function saveProject(){
    const name = document.getElementById('projectName').value.trim();
    const sum = parseFloat(document.getElementById('projectSum').value)||0;
    if(!name||!sum) return toast('‚ùå');
    
    D.projects.push({
        id: '–ü'+Date.now(),
        name,
        client: document.getElementById('projectClient').value.trim(),
        phone: document.getElementById('projectPhone').value.trim(),
        sum,
        paid: 0,
        status: 'active',
        stage: 0,
        dateStart: document.getElementById('projectDateStart').value || today(),
        deadline: document.getElementById('projectDeadline').value || '',
        author: document.getElementById('projectAuthor').value.trim(),
        ts: now()
    });
    
    if(await saveCloud()){
        closeModal('newProject');
        ['projectName','projectClient','projectPhone','projectSum'].forEach(id=>document.getElementById(id).value='');
        render();
        toast('‚úÖ');
    }
}
function filterProj(f,b){ projF=f; document.querySelectorAll('#projectsTabs .tab-btn').forEach(t=>t.classList.remove('active')); b.classList.add('active'); renderProjects(); }
async function setProjStatus(id,s){ const p=D.projects.find(x=>x.id===id); if(p){p.status=s;p.ts=now(); if(await saveCloud()){render();toast('‚úÖ');}} }
async function setStage(id,s){ const p=D.projects.find(x=>x.id===id); if(p){p.stage=s;p.ts=now(); if(await saveCloud()){viewProject(id);}} }
function viewProject(id){
    const p=D.projects.find(x=>x.id===id); if(!p)return;
    const pI=D.income.filter(i=>i.projectId===id&&!i._archived);
    const pE=D.expenses.filter(e=>e.projectId===id&&!e._archived);
    const tI=pI.reduce((s,i)=>s+i.amount,0);
    const tE=pE.reduce((s,e)=>s+e.amount,0);
    const st=['–ó–∞–º–µ—Ä','–î–∏–∑–∞–π–Ω','–ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ','–î–æ—Å—Ç–∞–≤–∫–∞','–ú–æ–Ω—Ç–∞–∂','–ì–æ—Ç–æ–≤–æ'];
    const ph=(p.phone||'').replace(/\D/g,'');
    document.getElementById('viewProjectTitle').textContent=p.name;
    document.getElementById('viewProjectContent').innerHTML=`
        <div class="list-item"><div>üë§ ${p.client||'‚Äî'} ‚Ä¢ üìû ${p.phone||'‚Äî'}</div><div>üìÖ ${fmtD(p.dateStart)} ‚Üí ${fmtD(p.deadline)}</div>${p.author?`<div class="author">–°–æ–∑–¥–∞–ª: ${p.author}</div>`:''}</div>
        ${ph?`<div class="contact-btns"><a href="https://wa.me/${ph}" class="contact-btn whatsapp">üí¨</a><a href="tel:${ph}" class="contact-btn phone">üìû</a></div>`:''}
        <div class="card" style="margin-top:12px"><div class="stages">${st.map((s,i)=>`<div class="stage ${i<p.stage?'done':i===p.stage?'active':''}" onclick="setStage('${id}',${i})">${s}</div>`).join('')}</div></div>
        <div class="summary-grid" style="margin-top:12px">
            <div class="summary-card"><div class="label">–î–æ–≥–æ–≤–æ—Ä</div><div class="value">${fmt(p.sum)}</div></div>
            <div class="summary-card"><div class="label">–û–ø–ª–∞—á–µ–Ω–æ</div><div class="value income">${fmt(p.paid)}</div></div>
            <div class="summary-card"><div class="label">–†–∞—Å—Ö–æ–¥—ã</div><div class="value expense">${fmt(tE)}</div></div>
            <div class="summary-card"><div class="label">–ü—Ä–∏–±—ã–ª—å</div><div class="value ${tI-tE>=0?'income':'expense'}">${fmt(tI-tE)}</div></div>
        </div>
        <div class="progress-bar"><div class="fill" style="width:${Math.min(100,p.sum?p.paid/p.sum*100:0)}%;background:var(--green)"></div></div>`;
    openModal('viewProject');
}

// ============ INCOME ============
async function saveIncome(){
    const projectId = document.getElementById('incomeProject').value;
    const amount = parseFloat(document.getElementById('incomeAmount').value)||0;
    if(!projectId||!amount) return toast('‚ùå');
    
    D.income.push({
        id: '–î'+Date.now(),
        projectId,
        amount,
        type: document.getElementById('incomeType').value,
        method: document.getElementById('incomeMethod').value,
        note: document.getElementById('incomeNote').value,
        date: today(),
        author: document.getElementById('incomeAuthor').value.trim(),
        ts: now()
    });
    
    if(await saveCloud()){
        document.getElementById('incomeAmount').value='';
        document.getElementById('incomeNote').value='';
        render();
        toast('‚úÖ');
    }
}
function setIncomeFilter(f,b){ incF=f; document.querySelectorAll('#incomeTabs .tab-btn').forEach(t=>t.classList.remove('active')); b.classList.add('active'); renderIncome(); }
async function archiveIncome(id){
    const who = prompt('–ö—Ç–æ –∞—Ä—Ö–∏–≤–∏—Ä—É–µ—Ç?'); if(!who) return;
    const i = D.income.find(x=>x.id===id);
    if(i){
        i._archived = true;
        i._archivedBy = who;
        i._archivedAt = now();
        i.ts = now();
        if(await saveCloud()){ render(); toast('üì¶'); }
    }
}
async function restoreIncome(id){
    const i = D.income.find(x=>x.id===id);
    if(i){
        i._archived = false;
        i.ts = now();
        if(await saveCloud()){ render(); toast('‚ôªÔ∏è'); }
    }
}

// ============ EXPENSE ============
async function saveExpense(){
    const amount = parseFloat(document.getElementById('expenseAmount').value)||0;
    if(!amount) return toast('‚ùå');
    
    D.expenses.push({
        id: '–†'+Date.now(),
        projectId: document.getElementById('expenseProject').value,
        category: document.getElementById('expenseCategory').value,
        amount,
        method: document.getElementById('expenseMethod').value,
        desc: document.getElementById('expenseDesc').value,
        photo,
        date: today(),
        author: document.getElementById('expenseAuthor').value.trim(),
        ts: now()
    });
    
    if(await saveCloud()){
        document.getElementById('expenseAmount').value='';
        document.getElementById('expenseDesc').value='';
        document.getElementById('expensePhoto').value='';
        document.getElementById('photoPreview').style.display='none';
        photo = null;
        render();
        toast('‚úÖ');
    }
}
function setExpenseFilter(f,b){ expF=f; document.querySelectorAll('#expenseTabs .tab-btn').forEach(t=>t.classList.remove('active')); b.classList.add('active'); renderExpenses(); }
async function archiveExpense(id){
    const who = prompt('–ö—Ç–æ –∞—Ä—Ö–∏–≤–∏—Ä—É–µ—Ç?'); if(!who) return;
    const e = D.expenses.find(x=>x.id===id);
    if(e){
        e._archived = true;
        e._archivedBy = who;
        e._archivedAt = now();
        e.ts = now();
        if(await saveCloud()){ render(); toast('üì¶'); }
    }
}
async function restoreExpense(id){
    const e = D.expenses.find(x=>x.id===id);
    if(e){
        e._archived = false;
        e.ts = now();
        if(await saveCloud()){ render(); toast('‚ôªÔ∏è'); }
    }
}

// ============ ASSETS ============
async function addAsset(){
    const name = document.getElementById('newAssetName').value.trim();
    const qty = parseFloat(document.getElementById('newAssetQty').value)||0;
    const cost = parseFloat(document.getElementById('newAssetCost').value)||0;
    if(!name||!qty||!cost) return toast('‚ùå');
    
    const unit = document.getElementById('newAssetUnit').value;
    const ex = D.assets.find(a=>a.name.toLowerCase()===name.toLowerCase()&&a.unit===unit);
    
    if(ex){
        ex.qty += qty;
        ex.totalCost += cost;
        ex.pricePerUnit = ex.totalCost / ex.qty;
        ex.ts = now();
    } else {
        D.assets.push({
            id: '–ê'+Date.now(),
            name,
            qty,
            unit,
            pricePerUnit: cost/qty,
            totalCost: cost,
            author: document.getElementById('assetAuthor').value.trim(),
            ts: now()
        });
    }
    
    if(await saveCloud()){
        closeModal('addAsset');
        ['newAssetName','newAssetQty','newAssetCost'].forEach(id=>document.getElementById(id).value='');
        render();
        toast('‚úÖ');
    }
}
function fillAssetModal(){
    document.getElementById('useAssetSelect').innerHTML = D.assets.filter(a=>a.qty>0).map(a=>`<option value="${a.id}">${a.name} (${a.qty} ${a.unit})</option>`).join('')||'<option>–ù–µ—Ç</option>';
    document.getElementById('useAssetProject').innerHTML = D.projects.filter(p=>p.status==='active').map(p=>`<option value="${p.id}">${p.name}</option>`).join('')||'<option>–ù–µ—Ç</option>';
}
async function useAsset(){
    const aId = document.getElementById('useAssetSelect').value;
    const qty = parseFloat(document.getElementById('useAssetQty').value)||0;
    const a = D.assets.find(x=>x.id===aId);
    if(!a||qty<=0||qty>a.qty) return toast('‚ùå');
    
    const cost = a.pricePerUnit * qty;
    a.qty -= qty;
    a.totalCost = a.qty * a.pricePerUnit;
    a.ts = now();
    
    D.expenses.push({
        id: '–†'+Date.now(),
        projectId: document.getElementById('useAssetProject').value,
        category: '–°–æ —Å–∫–ª–∞–¥–∞',
        amount: cost,
        desc: `${a.name} x${qty} ${a.unit}`,
        date: today(),
        author: document.getElementById('useAssetAuthor').value.trim(),
        ts: now()
    });
    
    if(await saveCloud()){
        closeModal('useAsset');
        render();
        toast('‚úÖ');
    }
}

// ============ RENDER ============
function render(){ renderSelects(); renderHome(); renderProjects(); renderIncome(); renderExpenses(); renderAssets(); renderAnalytics(); }

function renderSelects(){
    const active = D.projects.filter(p=>p.status==='active');
    const opts = active.map(p=>`<option value="${p.id}">${p.name}</option>`).join('');
    document.getElementById('incomeProject').innerHTML = opts || '<option value="">–ù–µ—Ç –ø—Ä–æ–µ–∫—Ç–æ–≤</option>';
    document.getElementById('expenseProject').innerHTML = (opts||'') + '<option value="–û–±—â–∏–µ">–û–±—â–∏–µ</option>';
}

function renderHome(){
    const aI = D.income.filter(i=>!i._archived);
    const aE = D.expenses.filter(e=>!e._archived);
    const tI = aI.reduce((s,i)=>s+i.amount,0);
    const tE = aE.reduce((s,e)=>s+e.amount,0);
    const tA = D.assets.reduce((s,a)=>s+(a.totalCost||0),0);
    
    document.getElementById('homeIncome').textContent = fmt(tI);
    document.getElementById('homeExpense').textContent = fmt(tE);
    document.getElementById('homeProfit').textContent = fmt(tI-tE);
    document.getElementById('homeAssets').textContent = fmt(tA);
    document.getElementById('homeFree').textContent = fmt(tI-tE-tA);
    
    const all = [...aI.map(i=>({...i,_t:'i'})), ...aE.map(e=>({...e,_t:'e'}))]
        .sort((a,b)=>(b.ts||b.date||'').localeCompare(a.ts||a.date||''))
        .slice(0,5);
    
    document.getElementById('recentOps').innerHTML = all.length ? all.map(o=>{
        if(o._t==='i'){
            const p = D.projects.find(x=>x.id===o.projectId);
            return `<div class="list-item"><div class="row"><div><div class="title">${p?p.name:o.projectId}</div><div class="subtitle">${fmtD(o.date)} ‚Ä¢ ${o.type}</div>${o.author?`<div class="author">üë§ ${o.author}</div>`:''}</div><div class="amount income">+${fmt(o.amount)}</div></div></div>`;
        }
        return `<div class="list-item"><div class="row"><div><div class="title">${o.category}</div><div class="subtitle">${fmtD(o.date)} ‚Ä¢ ${o.desc||''}</div>${o.author?`<div class="author">üë§ ${o.author}</div>`:''}</div><div class="amount expense">-${fmt(o.amount)}</div></div></div>`;
    }).join('') : '<div class="empty"><span>üì≠</span>–ü—É—Å—Ç–æ</div>';
}

function renderProjects(){
    const list = D.projects.filter(p=>p.status===projF);
    const st = ['–ó–∞–º–µ—Ä','–î–∏–∑–∞–π–Ω','–ü—Ä–æ–∏–∑–≤.','–î–æ—Å—Ç–∞–≤–∫–∞','–ú–æ–Ω—Ç–∞–∂','–ì–æ—Ç–æ–≤–æ'];
    const bd = {active:'<span class="badge badge-active">–í —Ä–∞–±–æ—Ç–µ</span>',done:'<span class="badge badge-done">–ó–∞–≤–µ—Ä—à—ë–Ω</span>',archive:'<span class="badge badge-archive">–ê—Ä—Ö–∏–≤</span>'};
    
    document.getElementById('projectsList').innerHTML = list.length ? list.map(p=>{
        const pc = p.sum ? Math.round(p.paid/p.sum*100) : 0;
        const pE = D.expenses.filter(e=>e.projectId===p.id&&!e._archived).reduce((s,e)=>s+e.amount,0);
        const mr = p.paid>0 ? Math.round((p.paid-pE)/p.paid*100) : 0;
        return `<div class="list-item">
            <div class="row"><div class="title">${p.name}</div><div class="amount">${fmt(p.sum)}</div></div>
            <div class="subtitle">${p.client||'‚Äî'} ‚Ä¢ ${fmtD(p.dateStart)}</div>
            ${p.author?`<div class="author">üë§ ${p.author}</div>`:''}
            <div>${bd[p.status]||''}<span class="badge badge-margin">${mr}%</span></div>
            <div class="stages">${st.map((s,i)=>`<div class="stage ${i<(p.stage||0)?'done':i===(p.stage||0)?'active':''}">${s}</div>`).join('')}</div>
            <div class="progress-bar"><div class="fill" style="width:${pc}%;background:${pc>=100?'var(--green)':pc>=50?'var(--yellow)':'var(--red)'}"></div></div>
            <div class="actions">
                <button class="action-btn" onclick="viewProject('${p.id}')">üëÅ</button>
                ${p.status==='active'?`<button class="action-btn" onclick="setProjStatus('${p.id}','done')">‚úÖ</button>`:''}
                ${p.status==='done'?`<button class="action-btn" onclick="setProjStatus('${p.id}','archive')">üì¶</button>`:''}
                ${p.status==='archive'?`<button class="action-btn" onclick="setProjStatus('${p.id}','active')">‚ôªÔ∏è</button>`:''}
            </div>
        </div>`;
    }).join('') : '<div class="empty"><span>üìã</span>–ü—É—Å—Ç–æ</div>';
}

function renderIncome(){
    const active = D.income.filter(i=>!i._archived).sort((a,b)=>(b.ts||b.date||'').localeCompare(a.ts||a.date||''));
    const archived = D.income.filter(i=>i._archived).sort((a,b)=>(b._archivedAt||'').localeCompare(a._archivedAt||''));
    const list = incF==='active' ? active : archived;
    
    document.getElementById('incomeCount').textContent = `(${active.length})`;
    document.getElementById('incomeList').innerHTML = list.length ? list.map(i=>{
        const p = D.projects.find(x=>x.id===i.projectId);
        const arch = i._archived;
        return `<div class="list-item ${arch?'archived':''}">
            <div class="row"><div><div class="title">${p?p.name:i.projectId}</div><div class="subtitle">${fmtD(i.date)} ‚Ä¢ ${i.type} ‚Ä¢ ${i.method||''}</div>${i.author?`<div class="author">üë§ ${i.author}</div>`:''}</div><div class="amount income">+${fmt(i.amount)}</div></div>
            ${i.note?`<div class="subtitle">üí¨ ${i.note}</div>`:''}
            ${arch?`<div class="subtitle" style="color:var(--red)">üóë ${i._archivedBy||''} ‚Ä¢ ${fmtD((i._archivedAt||'').split('T')[0])}</div>`:''}
            <div class="actions">${arch?`<button class="action-btn success" onclick="restoreIncome('${i.id}')">‚ôªÔ∏è</button>`:`<button class="action-btn danger" onclick="archiveIncome('${i.id}')">üóë</button>`}</div>
        </div>`;
    }).join('') : '<div class="empty"><span>üì≠</span>–ü—É—Å—Ç–æ</div>';
}

function renderExpenses(){
    const active = D.expenses.filter(e=>!e._archived).sort((a,b)=>(b.ts||b.date||'').localeCompare(a.ts||a.date||''));
    const archived = D.expenses.filter(e=>e._archived).sort((a,b)=>(b._archivedAt||'').localeCompare(a._archivedAt||''));
    const list = expF==='active' ? active : archived;
    
    document.getElementById('expenseCount').textContent = `(${active.length})`;
    document.getElementById('expenseList').innerHTML = list.length ? list.map(e=>{
        const arch = e._archived;
        return `<div class="list-item ${arch?'archived':''}">
            <div class="row"><div><div class="title">${e.category}</div><div class="subtitle">${fmtD(e.date)} ‚Ä¢ ${e.projectId} ‚Ä¢ ${e.method||''}</div>${e.author?`<div class="author">üë§ ${e.author}</div>`:''}</div><div class="amount expense">-${fmt(e.amount)}</div></div>
            ${e.desc?`<div class="subtitle">üìù ${e.desc}</div>`:''}
            ${e.photo?`<img src="${e.photo}" class="photo-thumb" onclick="viewPhoto('${e.id}')">`:''}
            ${arch?`<div class="subtitle" style="color:var(--red)">üóë ${e._archivedBy||''} ‚Ä¢ ${fmtD((e._archivedAt||'').split('T')[0])}</div>`:''}
            <div class="actions">${arch?`<button class="action-btn success" onclick="restoreExpense('${e.id}')">‚ôªÔ∏è</button>`:`<button class="action-btn danger" onclick="archiveExpense('${e.id}')">üóë</button>`}</div>
        </div>`;
    }).join('') : '<div class="empty"><span>üì≠</span>–ü—É—Å—Ç–æ</div>';
}

function renderAssets(){
    const aa = D.assets.filter(a=>a.qty>0);
    document.getElementById('totalAssets').textContent = fmt(aa.reduce((s,a)=>s+(a.totalCost||0),0));
    document.getElementById('assetsList').innerHTML = aa.length ? aa.map(a=>`<div class="list-item"><div class="row"><div><div class="title">${a.name}</div><div class="subtitle">${fmt(a.pricePerUnit)} –∑–∞ ${a.unit}</div>${a.author?`<div class="author">üë§ ${a.author}</div>`:''}</div><div><div class="amount assets">${a.qty} ${a.unit}</div><div class="subtitle">${fmt(a.totalCost)}</div></div></div></div>`).join('') : '<div class="empty"><span>üì¶</span>–ü—É—Å—Ç–æ</div>';
}

function renderAnalytics(){
    const f = document.getElementById('dateFrom').value;
    const t = document.getElementById('dateTo').value;
    const inc = D.income.filter(i=>!i._archived&&(!f||i.date>=f)&&(!t||i.date<=t));
    const exp = D.expenses.filter(e=>!e._archived&&(!f||e.date>=f)&&(!t||e.date<=t));
    const tI = inc.reduce((s,i)=>s+i.amount,0);
    const tE = exp.reduce((s,e)=>s+e.amount,0);
    const tA = D.assets.reduce((s,a)=>s+(a.totalCost||0),0);
    
    document.getElementById('statIncome').textContent = fmt(tI);
    document.getElementById('statExpense').textContent = fmt(tE);
    document.getElementById('statFree').textContent = fmt(tI-tE-tA);
    
    const bc = {};
    exp.forEach(e=>{ bc[e.category] = (bc[e.category]||0) + e.amount; });
    const sc = Object.entries(bc).sort((a,b)=>b[1]-a[1]).slice(0,10);
    
    document.getElementById('categoryStats').innerHTML = sc.length ? sc.map(([c,s])=>`<div class="list-item"><div class="row"><div class="title">${c}</div><div class="amount expense">${fmt(s)}</div></div><div class="progress-bar"><div class="fill" style="width:${tE?Math.round(s/tE*100):0}%;background:var(--red)"></div></div></div>`).join('') : '<p style="color:var(--text2)">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</p>';
}

function exportBackup(){
    const a = document.createElement('a');
    a.href = URL.createObjectURL(new Blob([JSON.stringify(D,null,2)],{type:'application/json'}));
    a.download = 'backup_'+today()+'.json';
    a.click();
    toast('üíæ');
}

function importBackup(inp){
    if(!inp.files[0]) return;
    const r = new FileReader();
    r.onload = async e => {
        try{
            const d = JSON.parse(e.target.result);
            if(d.projects){
                D = d;
                if(await saveCloud()){ render(); toast('‚úÖ'); }
            }
        } catch{ toast('‚ùå'); }
    };
    r.readAsText(inp.files[0]);
    inp.value = '';
}

document.getElementById('dateFrom').addEventListener('change', renderAnalytics);
document.getElementById('dateTo').addEventListener('change', renderAnalytics);

init();
</script>
</body>
</html>
