<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>IDEAL MEBEL</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:-apple-system,sans-serif;background:#0d0d0d;color:#fff;min-height:100vh}
.app{display:flex;flex-direction:column;min-height:100vh}
.header{background:#1a1a1a;padding:16px;text-align:center;border-bottom:1px solid #333;position:sticky;top:0;z-index:100}
.header h1{font-size:20px;letter-spacing:2px}
.header-sub{font-size:11px;color:#999;margin-top:4px;display:flex;align-items:center;justify-content:center;gap:8px}
.sync-dot{width:8px;height:8px;border-radius:50%;background:#4CAF50}
.sync-dot.off{background:#ef5350}
.sync-dot.sync{background:#FFB74D;animation:pulse 1s infinite}
@keyframes pulse{50%{opacity:.5}}
.header-btns{position:absolute;right:12px;top:50%;transform:translateY(-50%);display:flex;gap:8px}
.header-btn{width:34px;height:34px;border-radius:10px;background:#252525;border:1px solid #333;color:#fff;font-size:14px}
.content{flex:1;padding:14px;padding-bottom:80px;max-width:600px;margin:0 auto;width:100%}
.nav{position:fixed;bottom:0;left:0;right:0;background:#1a1a1a;display:flex;justify-content:space-around;padding:8px;border-top:1px solid #333}
.nav-btn{display:flex;flex-direction:column;align-items:center;gap:2px;background:none;border:none;color:#999;font-size:9px;padding:6px 10px;border-radius:10px}
.nav-btn.active{color:#A69076;background:rgba(139,115,85,.15)}
.nav-btn span{font-size:20px}
.panel{display:none}.panel.active{display:block}
.card{background:#1a1a1a;border-radius:16px;padding:14px;margin-bottom:12px;border:1px solid #333}
.card-title{font-size:13px;color:#999;margin-bottom:12px}
.form-group{margin-bottom:12px}
.form-group label{display:block;font-size:11px;color:#999;margin-bottom:5px}
input,select{width:100%;padding:12px;background:#252525;border:1px solid #333;border-radius:12px;color:#fff;font-size:16px}
.btn{width:100%;padding:14px;border:none;border-radius:12px;font-size:15px;font-weight:600;cursor:pointer}
.btn-primary{background:linear-gradient(135deg,#8B7355,#A69076);color:#fff}
.btn-green{background:#4CAF50;color:#fff}
.btn-red{background:#ef5350;color:#fff}
.summary-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:14px}
.summary-card{background:#1a1a1a;border-radius:14px;padding:12px;border:1px solid #333}
.summary-card .label{font-size:10px;color:#999}
.summary-card .value{font-size:18px;font-weight:700;margin-top:2px}
.green{color:#4CAF50}.red{color:#ef5350}.yellow{color:#FFB74D}
.profit-box{background:#1a1a1a;border:2px solid #8B7355;border-radius:16px;padding:16px;margin-bottom:14px;text-align:center}
.profit-box .label{font-size:11px;color:#999}
.profit-box .value{font-size:28px;font-weight:700;color:#4CAF50}
.period-tabs{display:flex;gap:6px;margin-bottom:14px}
.period-btn{flex:1;padding:10px;background:#1a1a1a;border:1px solid #333;border-radius:12px;color:#999;font-size:11px}
.period-btn.active{background:#8B7355;color:#fff;border-color:#8B7355}
.tabs{display:flex;gap:6px;margin-bottom:14px;overflow-x:auto}
.tab-btn{padding:8px 12px;background:#1a1a1a;border:1px solid #333;border-radius:20px;color:#999;font-size:11px;white-space:nowrap}
.tab-btn.active{background:#8B7355;color:#fff;border-color:#8B7355}
.list-item{background:#1a1a1a;border-radius:12px;padding:12px;margin-bottom:8px;border:1px solid #333}
.list-item .row{display:flex;justify-content:space-between;align-items:flex-start}
.list-item .title{font-weight:600;font-size:14px}
.list-item .sub{font-size:11px;color:#999;margin-top:2px}
.list-item .amount{font-weight:700;font-size:15px}
.actions{display:flex;gap:5px;margin-top:8px}
.act-btn{padding:6px 10px;background:#252525;border:1px solid #333;border-radius:8px;color:#fff;font-size:11px}
.act-btn.red{color:#ef5350}
.act-btn.green{color:#4CAF50}
.quick-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-bottom:14px}
.quick-btn{display:flex;flex-direction:column;align-items:center;gap:4px;padding:12px 6px;background:#1a1a1a;border:1px solid #333;border-radius:12px;color:#fff;font-size:10px}
.quick-btn span{font-size:22px}
.money-tags{display:flex;gap:6px;margin:8px 0;flex-wrap:wrap}
.money-tag{padding:6px 10px;border-radius:8px;font-size:12px;font-weight:600}
.money-tag.white{background:#fff;color:#000}
.money-tag.yellow{background:#FFB74D;color:#000}
.stages{display:flex;gap:3px;margin-top:8px}
.stage{padding:4px 8px;background:#252525;border-radius:6px;font-size:9px;color:#999}
.stage.done{background:#4CAF50;color:#fff}
.stage.now{background:#8B7355;color:#fff}
.progress{height:5px;background:#252525;border-radius:3px;margin-top:8px;overflow:hidden}
.progress .fill{height:100%;background:#4CAF50;border-radius:3px}
.modal{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.9);z-index:200;align-items:flex-end}
.modal.active{display:flex}
.modal-box{background:#1a1a1a;border-radius:20px 20px 0 0;padding:18px;width:100%;max-height:85vh;overflow-y:auto}
.modal-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
.modal-title{font-size:17px;font-weight:600}
.modal-close{width:32px;height:32px;border-radius:50%;background:#252525;border:1px solid #333;color:#fff;font-size:18px}
.empty{text-align:center;padding:30px;color:#999}
.empty span{font-size:40px;display:block;margin-bottom:10px}
.toast{position:fixed;bottom:100px;left:50%;transform:translateX(-50%);background:#1a1a1a;padding:12px 20px;border-radius:12px;display:none;z-index:300;border:1px solid #333}
</style>
</head>
<body>
<div class="app">
<div class="header">
<h1>IDEAL MEBEL</h1>
<div class="header-sub"><span class="sync-dot" id="dot"></span><span id="status">OK</span></div>
<div class="header-btns"><button class="header-btn" onclick="sync()">üîÑ</button><button class="header-btn" onclick="showModal('settings')">‚öôÔ∏è</button></div>
</div>
<div class="content">
<!-- –ì–õ–ê–í–ù–ê–Ø -->
<div id="p-home" class="panel active">
<div class="period-tabs">
<button class="period-btn active" onclick="setPer('all',this)">–í—Å—ë</button>
<button class="period-btn" onclick="setPer('year',this)">–ì–æ–¥</button>
<button class="period-btn" onclick="setPer('month',this)">–ú–µ—Å</button>
<button class="period-btn" onclick="setPer('week',this)">–ù–µ–¥</button>
</div>
<div class="profit-box"><div class="label">üíµ –°–í–û–ë–û–î–ù–´–ï –î–ï–ù–¨–ì–ò</div><div class="value" id="hFree">0 ‚ÇΩ</div></div>
<div class="summary-grid">
<div class="summary-card"><div class="label">üí∞ –î–æ—Ö–æ–¥—ã</div><div class="value green" id="hInc">0 ‚ÇΩ</div></div>
<div class="summary-card"><div class="label">üí∏ –†–∞—Å—Ö–æ–¥—ã</div><div class="value red" id="hExp">0 ‚ÇΩ</div></div>
<div class="summary-card"><div class="label">üìä –ü—Ä–∏–±—ã–ª—å</div><div class="value" id="hProf">0 ‚ÇΩ</div></div>
<div class="summary-card"><div class="label">üì¶ –°–∫–ª–∞–¥</div><div class="value yellow" id="hAss">0 ‚ÇΩ</div></div>
</div>
<div class="quick-grid">
<button class="quick-btn" onclick="go('income')"><span>üí∞</span>–î–æ—Ö–æ–¥</button>
<button class="quick-btn" onclick="go('expense')"><span>üí∏</span>–†–∞—Å—Ö–æ–¥</button>
<button class="quick-btn" onclick="newProj()"><span>üìã</span>–ü—Ä–æ–µ–∫—Ç</button>
<button class="quick-btn" onclick="showModal('addAsset')"><span>üì¶</span>–°–∫–ª–∞–¥</button>
</div>
<div class="card"><div class="card-title">üìÅ –ü–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º</div><div id="hCats"></div></div>
<div class="card"><div class="card-title">üìà –ü–æ—Å–ª–µ–¥–Ω–∏–µ</div><div id="hRecent"></div></div>
</div>
<!-- –ü–†–û–ï–ö–¢–´ -->
<div id="p-projects" class="panel">
<div class="tabs">
<button class="tab-btn active" onclick="setProjF('active',this)">–í —Ä–∞–±–æ—Ç–µ</button>
<button class="tab-btn" onclick="setProjF('done',this)">–ó–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–µ</button>
<button class="tab-btn" onclick="setProjF('archive',this)">–ê—Ä—Ö–∏–≤</button>
<button class="tab-btn" onclick="setProjF('deleted',this)">–£–¥–∞–ª—ë–Ω–Ω—ã–µ</button>
</div>
<button class="btn btn-primary" onclick="newProj()" style="margin-bottom:14px">‚ûï –ù–æ–≤—ã–π –ø—Ä–æ–µ–∫—Ç</button>
<div id="projList"></div>
</div>
<!-- –î–û–•–û–î–´ -->
<div id="p-income" class="panel">
<div class="card">
<div class="card-title">üí∞ –ó–∞–ø–∏—Å–∞—Ç—å –¥–æ—Ö–æ–¥</div>
<div class="form-group"><label>–ê–≤—Ç–æ—Ä</label><input id="iAuthor"></div>
<div class="form-group"><label>–ü—Ä–æ–µ–∫—Ç</label><select id="iProj"></select></div>
<div class="form-group"><label>–°—É–º–º–∞</label><input type="number" id="iSum" inputmode="decimal"></div>
<div class="form-group"><label>–¢–∏–ø</label><select id="iType"><option>–ü—Ä–µ–¥–æ–ø–ª–∞—Ç–∞</option><option>–ß–∞—Å—Ç–∏—á–Ω–∞—è</option><option>–§–∏–Ω–∞–ª—å–Ω–∞—è</option><option>–§–∏—Ä–º–∞</option></select></div>
<button class="btn btn-green" onclick="addInc()">‚úÖ –ó–∞–ø–∏—Å–∞—Ç—å</button>
</div>
<div class="card">
<div class="card-title">–ò—Å—Ç–æ—Ä–∏—è</div>
<div class="tabs">
<button class="tab-btn active" onclick="setIncF('active',this)">–ê–∫—Ç—É–∞–ª—å–Ω—ã–µ</button>
<button class="tab-btn" onclick="setIncF('archived',this)">–ê—Ä—Ö–∏–≤</button>
<button class="tab-btn" onclick="setIncF('deleted',this)">–£–¥–∞–ª—ë–Ω–Ω—ã–µ</button>
</div>
<div id="incList"></div>
</div>
</div>
<!-- –†–ê–°–•–û–î–´ -->
<div id="p-expense" class="panel">
<div class="card">
<div class="card-title">üí∏ –ó–∞–ø–∏—Å–∞—Ç—å —Ä–∞—Å—Ö–æ–¥</div>
<div class="form-group"><label>–ê–≤—Ç–æ—Ä</label><input id="eAuthor"></div>
<div class="form-group"><label>–ü—Ä–æ–µ–∫—Ç</label><select id="eProj"></select></div>
<div class="form-group"><label>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label><select id="eCat"><option>–ú–∞–≥–∞–∑–∏–Ω—ã</option><option>–ú–∞—Ç–µ—Ä–∏–∞–ª—ã</option><option>–î–æ—Å—Ç–∞–≤–∫–∞</option><option>–ë–µ–Ω–∑–∏–Ω</option><option>–ê—Ä–µ–Ω–¥–∞</option><option>–ó–ü</option><option>–ü—Ä–æ—á–∏–µ</option><option>–§–∏—Ä–º–∞</option></select></div>
<div class="form-group"><label>–°—É–º–º–∞</label><input type="number" id="eSum" inputmode="decimal"></div>
<div class="form-group"><label>–û–ø–∏—Å–∞–Ω–∏–µ</label><input id="eDesc"></div>
<button class="btn btn-red" onclick="addExp()">üí∏ –ó–∞–ø–∏—Å–∞—Ç—å</button>
</div>
<div class="card">
<div class="card-title">–ò—Å—Ç–æ—Ä–∏—è</div>
<div class="tabs">
<button class="tab-btn active" onclick="setExpF('active',this)">–ê–∫—Ç—É–∞–ª—å–Ω—ã–µ</button>
<button class="tab-btn" onclick="setExpF('archived',this)">–ê—Ä—Ö–∏–≤</button>
<button class="tab-btn" onclick="setExpF('deleted',this)">–£–¥–∞–ª—ë–Ω–Ω—ã–µ</button>
</div>
<div id="expList"></div>
</div>
</div>
<!-- –°–ö–õ–ê–î -->
<div id="p-assets" class="panel">
<div class="profit-box"><div class="label">üì¶ –ù–ê –°–ö–õ–ê–î–ï</div><div class="value yellow" id="assTotal">0 ‚ÇΩ</div></div>
<button class="btn btn-primary" onclick="showModal('addAsset')" style="margin-bottom:14px">‚ûï –î–æ–±–∞–≤–∏—Ç—å</button>
<div id="assList"></div>
</div>
</div>
<nav class="nav">
<button class="nav-btn active" onclick="go('home')"><span>üè†</span>–ì–ª–∞–≤–Ω–∞—è</button>
<button class="nav-btn" onclick="go('projects')"><span>üìã</span>–ü—Ä–æ–µ–∫—Ç—ã</button>
<button class="nav-btn" onclick="go('income')"><span>üí∞</span>–î–æ—Ö–æ–¥</button>
<button class="nav-btn" onclick="go('expense')"><span>üí∏</span>–†–∞—Å—Ö–æ–¥</button>
<button class="nav-btn" onclick="go('assets')"><span>üì¶</span>–°–∫–ª–∞–¥</button>
</nav>
</div>
<div class="toast" id="toast"></div>
<!-- –ú–û–î–ê–õ–ö–ò -->
<div class="modal" id="m-project"><div class="modal-box">
<div class="modal-head"><div class="modal-title" id="projTitle">–ù–æ–≤—ã–π –ø—Ä–æ–µ–∫—Ç</div><button class="modal-close" onclick="hideModal('project')">‚úï</button></div>
<input type="hidden" id="projId">
<div class="form-group"><label>–ù–∞–∑–≤–∞–Ω–∏–µ</label><input id="projName"></div>
<div class="form-group"><label>–ö–ª–∏–µ–Ω—Ç</label><input id="projClient"></div>
<div class="form-group"><label>–¢–µ–ª–µ—Ñ–æ–Ω</label><input id="projPhone"></div>
<div class="form-group"><label>–ê–¥—Ä–µ—Å</label><input id="projAddr"></div>
<div class="form-group"><label>–°—É–º–º–∞ –¥–æ–≥–æ–≤–æ—Ä–∞</label><input type="number" id="projSum" inputmode="decimal"></div>
<button class="btn btn-primary" onclick="saveProj()">‚úÖ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
</div></div>
<div class="modal" id="m-addAsset"><div class="modal-box">
<div class="modal-head"><div class="modal-title">–î–æ–±–∞–≤–∏—Ç—å –º–∞—Ç–µ—Ä–∏–∞–ª</div><button class="modal-close" onclick="hideModal('addAsset')">‚úï</button></div>
<div class="form-group"><label>–ù–∞–∑–≤–∞–Ω–∏–µ</label><input id="assName"></div>
<div class="form-group"><label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</label><input type="number" id="assQty" inputmode="decimal"></div>
<div class="form-group"><label>–°—Ç–æ–∏–º–æ—Å—Ç—å</label><input type="number" id="assCost" inputmode="decimal"></div>
<button class="btn btn-primary" onclick="addAsset()">‚úÖ –î–æ–±–∞–≤–∏—Ç—å</button>
</div></div>
<div class="modal" id="m-settings"><div class="modal-box">
<div class="modal-head"><div class="modal-title">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</div><button class="modal-close" onclick="hideModal('settings')">‚úï</button></div>
<button class="btn btn-primary" onclick="sync()" style="margin-bottom:10px">üîÑ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å</button>
<button class="btn" style="background:#252525;border:1px solid #333" onclick="backup()">üíæ –°–∫–∞—á–∞—Ç—å –±—ç–∫–∞–ø</button>
</div></div>
<div class="modal" id="m-editInc"><div class="modal-box">
<div class="modal-head"><div class="modal-title">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –¥–æ—Ö–æ–¥</div><button class="modal-close" onclick="hideModal('editInc')">‚úï</button></div>
<input type="hidden" id="eiId">
<div class="form-group"><label>–ü—Ä–æ–µ–∫—Ç</label><select id="eiProj"></select></div>
<div class="form-group"><label>–°—É–º–º–∞</label><input type="number" id="eiSum" inputmode="decimal"></div>
<div class="form-group"><label>–¢–∏–ø</label><select id="eiType"><option>–ü—Ä–µ–¥–æ–ø–ª–∞—Ç–∞</option><option>–ß–∞—Å—Ç–∏—á–Ω–∞—è</option><option>–§–∏–Ω–∞–ª—å–Ω–∞—è</option><option>–§–∏—Ä–º–∞</option></select></div>
<button class="btn btn-primary" onclick="saveInc()">‚úÖ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
</div></div>
<div class="modal" id="m-editExp"><div class="modal-box">
<div class="modal-head"><div class="modal-title">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ä–∞—Å—Ö–æ–¥</div><button class="modal-close" onclick="hideModal('editExp')">‚úï</button></div>
<input type="hidden" id="eeId">
<div class="form-group"><label>–ü—Ä–æ–µ–∫—Ç</label><select id="eeProj"></select></div>
<div class="form-group"><label>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label><select id="eeCat"><option>–ú–∞–≥–∞–∑–∏–Ω—ã</option><option>–ú–∞—Ç–µ—Ä–∏–∞–ª—ã</option><option>–î–æ—Å—Ç–∞–≤–∫–∞</option><option>–ë–µ–Ω–∑–∏–Ω</option><option>–ê—Ä–µ–Ω–¥–∞</option><option>–ó–ü</option><option>–ü—Ä–æ—á–∏–µ</option><option>–§–∏—Ä–º–∞</option></select></div>
<div class="form-group"><label>–°—É–º–º–∞</label><input type="number" id="eeSum" inputmode="decimal"></div>
<div class="form-group"><label>–û–ø–∏—Å–∞–Ω–∏–µ</label><input id="eeDesc"></div>
<button class="btn btn-primary" onclick="saveExp()">‚úÖ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
</div></div>
<script>
var API='https://script.google.com/macros/s/AKfycbwlmez3kvl2aq6oiDCbMRjBuwlyEVjkx0FNexmnU40A81JsMeI9fsmAResAoktYhr_0/exec';
var D={projects:[],income:[],expenses:[],assets:[]};
var period='all',projF='active',incF='active',expF='active',syncing=false;

function $(id){return document.getElementById(id)}
function fmt(n){return(Math.round(n)||0).toString().replace(/\B(?=(\d{3})+(?!\d))/g,' ')+' ‚ÇΩ'}
function now(){return new Date().toISOString()}
function today(){return now().split('T')[0]}
function toast(m){var t=$('toast');t.textContent=m;t.style.display='block';setTimeout(function(){t.style.display='none'},1500)}

function go(name){
    document.querySelectorAll('.panel').forEach(function(p){p.classList.remove('active')});
    document.querySelectorAll('.nav-btn').forEach(function(b){b.classList.remove('active')});
    $('p-'+name).classList.add('active');
    document.querySelectorAll('.nav-btn').forEach(function(b){if(b.textContent.toLowerCase().indexOf(name.substring(0,3))>-1||name==='home'&&b.textContent.indexOf('–ì–ª–∞–≤–Ω–∞—è')>-1)b.classList.add('active')});
}

function showModal(name){$('m-'+name).classList.add('active')}
function hideModal(name){$('m-'+name).classList.remove('active')}

function setPer(p,btn){
    period=p;
    document.querySelectorAll('.period-btn').forEach(function(b){b.classList.remove('active')});
    if(btn)btn.classList.add('active');
    renderHome();
}
function setProjF(f,btn){
    projF=f;
    document.querySelectorAll('#p-projects .tab-btn').forEach(function(b){b.classList.remove('active')});
    if(btn)btn.classList.add('active');
    renderProj();
}
function setIncF(f,btn){
    incF=f;
    document.querySelectorAll('#p-income .tab-btn').forEach(function(b){b.classList.remove('active')});
    if(btn)btn.classList.add('active');
    renderInc();
}
function setExpF(f,btn){
    expF=f;
    document.querySelectorAll('#p-expense .tab-btn').forEach(function(b){b.classList.remove('active')});
    if(btn)btn.classList.add('active');
    renderExp();
}

function getPerStart(){
    if(period==='all')return'2000-01-01';
    var d=new Date();
    if(period==='week')d.setDate(d.getDate()-7);
    else if(period==='month')d.setMonth(d.getMonth()-1);
    else if(period==='year')d.setFullYear(d.getFullYear()-1);
    return d.toISOString().split('T')[0];
}

function merge(local,cloud){
    var map={};
    (cloud||[]).forEach(function(x){if(x&&x.id)map[x.id]=x});
    (local||[]).forEach(function(x){
        if(!x||!x.id)return;
        if(!map[x.id])map[x.id]=x;
        else if((x.ts||'')>(map[x.id].ts||''))map[x.id]=x;
    });
    return Object.values(map);
}

function loadLocal(){
    try{
        var s=localStorage.getItem('IM20')||localStorage.getItem('IM19')||localStorage.getItem('IM18')||localStorage.getItem('IM17');
        if(s)D=JSON.parse(s);
    }catch(e){}
}
function saveLocal(){try{localStorage.setItem('IM20',JSON.stringify(D))}catch(e){}}

function fix(){
    D.projects=D.projects||[];D.income=D.income||[];D.expenses=D.expenses||[];D.assets=D.assets||[];
    D.projects.forEach(function(p){p.sum=parseFloat(p.sum)||0;p.stage=parseInt(p.stage)||0;p.paid=D.income.filter(function(i){return i.projectId===p.id&&!i._archived&&!i._deleted}).reduce(function(s,i){return s+(parseFloat(i.amount)||0)},0)});
    D.income.forEach(function(i){i.amount=parseFloat(i.amount)||0});
    D.expenses.forEach(function(e){e.amount=parseFloat(e.amount)||0});
    D.assets.forEach(function(a){a.qty=parseFloat(a.qty)||0;a.cost=parseFloat(a.cost)||0});
}

function setSync(s){
    $('dot').className='sync-dot'+(s==='on'?'':s==='off'?' off':' sync');
    $('status').textContent=s==='on'?'OK':s==='off'?'–û—Ñ–ª–∞–π–Ω':'...';
}

async function loadCloud(){
    if(syncing)return;syncing=true;setSync('sync');
    try{
        var r=await fetch(API+'?action=getData&t='+Date.now());
        var c=await r.json();
        if(c&&c.projects!==undefined){
            D.projects=merge(D.projects,c.projects);
            D.income=merge(D.income,c.income);
            D.expenses=merge(D.expenses,c.expenses);
            D.assets=merge(D.assets,c.assets);
            fix();saveLocal();render();setSync('on');
        }else setSync('off');
    }catch(e){setSync('off')}
    syncing=false;
}

async function saveCloud(){
    if(syncing)return false;syncing=true;setSync('sync');
    try{
        var r1=await fetch(API+'?action=getData&t='+Date.now());
        var c=await r1.json();
        if(c&&c.projects!==undefined){
            D.projects=merge(D.projects,c.projects);
            D.income=merge(D.income,c.income);
            D.expenses=merge(D.expenses,c.expenses);
            D.assets=merge(D.assets,c.assets);
        }
        fix();
        var r2=await fetch(API+'?action=saveData',{method:'POST',body:JSON.stringify(D)});
        var res=await r2.json();
        if(res.success){saveLocal();setSync('on');syncing=false;return true}
    }catch(e){}
    setSync('off');syncing=false;return false;
}

async function sync(){toast('üîÑ');await loadCloud();render();toast('‚úÖ')}

function render(){
    renderSelects();
    renderHome();
    renderProj();
    renderInc();
    renderExp();
    renderAss();
}

function renderSelects(){
    var curInc=$('iProj').value;
    var curExp=$('eProj').value;
    var opts=D.projects.filter(function(p){return p.status==='active'&&!p._deleted}).map(function(p){return'<option value="'+p.id+'">'+p.name+'</option>'}).join('');
    $('iProj').innerHTML=opts||'<option>–ù–µ—Ç –ø—Ä–æ–µ–∫—Ç–æ–≤</option>';
    $('eProj').innerHTML='<option value="–û–±—â–∏–µ">–û–±—â–∏–µ</option>'+opts;
    $('eiProj').innerHTML=opts||'<option>–ù–µ—Ç</option>';
    $('eeProj').innerHTML='<option value="–û–±—â–∏–µ">–û–±—â–∏–µ</option>'+opts;
    // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—ã–±–æ—Ä
    if(curInc)$('iProj').value=curInc;
    if(curExp)$('eProj').value=curExp;
}

function renderHome(){
    var start=getPerStart();
    var inc=D.income.filter(function(i){return!i._archived&&!i._deleted&&(period==='all'||(i.date||'')>=start)});
    var exp=D.expenses.filter(function(e){return!e._archived&&!e._deleted&&(period==='all'||(e.date||'')>=start)});
    var tInc=inc.reduce(function(s,i){return s+i.amount},0);
    var tExp=exp.reduce(function(s,e){return s+e.amount},0);
    var tAss=D.assets.reduce(function(s,a){return s+(a.qty*a.cost/a.qty||0)},0);
    $('hInc').textContent=fmt(tInc);
    $('hExp').textContent=fmt(tExp);
    $('hProf').textContent=fmt(tInc-tExp);
    $('hAss').textContent=fmt(tAss);
    $('hFree').textContent=fmt(tInc-tExp-tAss);
    
    var cats={};exp.forEach(function(e){cats[e.category]=(cats[e.category]||0)+e.amount});
    var sorted=Object.entries(cats).sort(function(a,b){return b[1]-a[1]}).slice(0,5);
    $('hCats').innerHTML=sorted.length?sorted.map(function(c){return'<div class="list-item"><div class="row"><div class="title">'+c[0]+'</div><div class="amount red">'+fmt(c[1])+'</div></div></div>'}).join(''):'<div class="empty">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div>';
    
    var all=inc.map(function(i){return{t:'i',d:i.date||i.ts,data:i}}).concat(exp.map(function(e){return{t:'e',d:e.date||e.ts,data:e}})).sort(function(a,b){return(b.d||'').localeCompare(a.d||'')}).slice(0,5);
    $('hRecent').innerHTML=all.length?all.map(function(x){
        if(x.t==='i'){var p=D.projects.find(function(pr){return pr.id===x.data.projectId});return'<div class="list-item"><div class="row"><div><div class="title">'+(p?p.name:'‚Äî')+'</div><div class="sub">'+x.data.type+'</div></div><div class="amount green">+'+fmt(x.data.amount)+'</div></div></div>'}
        return'<div class="list-item"><div class="row"><div><div class="title">'+x.data.category+'</div><div class="sub">'+(x.data.desc||'')+'</div></div><div class="amount red">-'+fmt(x.data.amount)+'</div></div></div>'
    }).join(''):'<div class="empty"><span>üì≠</span>–ü—É—Å—Ç–æ</div>';
}

function renderProj(){
    var list=projF==='deleted'?D.projects.filter(function(p){return p._deleted}):D.projects.filter(function(p){return p.status===projF&&!p._deleted});
    $('projList').innerHTML=list.length?list.map(function(p){
        var pct=p.sum?Math.min(100,Math.round(p.paid/p.sum*100)):0;
        return'<div class="list-item">'+(p._deleted?'<div class="sub" style="color:#ef5350">–£–¥–∞–ª—ë–Ω</div>':'')+
        '<div class="title">'+p.name+'</div><div class="sub">'+(p.client||'')+'</div>'+
        '<div class="money-tags"><div class="money-tag white">üí∞ '+fmt(p.sum)+'</div><div class="money-tag white">‚úÖ '+fmt(p.paid)+'</div><div class="money-tag yellow">‚è≥ '+fmt(p.sum-p.paid)+'</div></div>'+
        '<div class="progress"><div class="fill" style="width:'+pct+'%"></div></div>'+
        '<div class="actions">'+
        (p._deleted?'<button class="act-btn green" onclick="restoreProj(\''+p.id+'\')">‚ôªÔ∏è</button>':
        '<button class="act-btn" onclick="editProj(\''+p.id+'\')">‚úèÔ∏è</button>'+
        (p.status==='active'?'<button class="act-btn" onclick="projStatus(\''+p.id+'\',\'done\')">‚úÖ</button>':'')+
        (p.status==='done'?'<button class="act-btn" onclick="projStatus(\''+p.id+'\',\'active\')">‚ôªÔ∏è</button><button class="act-btn" onclick="projStatus(\''+p.id+'\',\'archive\')">üì¶</button>':'')+
        (p.status==='archive'?'<button class="act-btn" onclick="projStatus(\''+p.id+'\',\'active\')">‚ôªÔ∏è</button>':'')+
        '<button class="act-btn red" onclick="delProj(\''+p.id+'\')">üóë</button>')+
        '</div></div>'
    }).join(''):'<div class="empty"><span>üìã</span>–ù–µ—Ç –ø—Ä–æ–µ–∫—Ç–æ–≤</div>';
}

function renderInc(){
    var list;
    if(incF==='deleted')list=D.income.filter(function(i){return i._deleted});
    else if(incF==='archived')list=D.income.filter(function(i){return i._archived&&!i._deleted});
    else list=D.income.filter(function(i){return!i._archived&&!i._deleted});
    list.sort(function(a,b){return(b.ts||'').localeCompare(a.ts||'')});
    $('incList').innerHTML=list.length?list.map(function(i){
        var p=D.projects.find(function(pr){return pr.id===i.projectId});
        return'<div class="list-item"><div class="row"><div><div class="title">'+(p?p.name:'‚Äî')+'</div><div class="sub">'+i.type+(i.author?' ‚Ä¢ '+i.author:'')+'</div></div><div class="amount green">+'+fmt(i.amount)+'</div></div>'+
        '<div class="actions">'+
        (i._deleted||i._archived?'<button class="act-btn green" onclick="restoreInc(\''+i.id+'\')">‚ôªÔ∏è</button>':
        '<button class="act-btn" onclick="editInc(\''+i.id+'\')">‚úèÔ∏è</button><button class="act-btn" onclick="archiveInc(\''+i.id+'\')">üì¶</button><button class="act-btn red" onclick="delInc(\''+i.id+'\')">üóë</button>')+
        '</div></div>'
    }).join(''):'<div class="empty"><span>üì≠</span>–ü—É—Å—Ç–æ</div>';
}

function renderExp(){
    var list;
    if(expF==='deleted')list=D.expenses.filter(function(e){return e._deleted});
    else if(expF==='archived')list=D.expenses.filter(function(e){return e._archived&&!e._deleted});
    else list=D.expenses.filter(function(e){return!e._archived&&!e._deleted});
    list.sort(function(a,b){return(b.ts||'').localeCompare(a.ts||'')});
    $('expList').innerHTML=list.length?list.map(function(e){
        return'<div class="list-item"><div class="row"><div><div class="title">'+e.category+'</div><div class="sub">'+(e.desc||'')+(e.author?' ‚Ä¢ '+e.author:'')+'</div></div><div class="amount red">-'+fmt(e.amount)+'</div></div>'+
        '<div class="actions">'+
        (e._deleted||e._archived?'<button class="act-btn green" onclick="restoreExp(\''+e.id+'\')">‚ôªÔ∏è</button>':
        '<button class="act-btn" onclick="editExp(\''+e.id+'\')">‚úèÔ∏è</button><button class="act-btn" onclick="archiveExp(\''+e.id+'\')">üì¶</button><button class="act-btn red" onclick="delExp(\''+e.id+'\')">üóë</button>')+
        '</div></div>'
    }).join(''):'<div class="empty"><span>üì≠</span>–ü—É—Å—Ç–æ</div>';
}

function renderAss(){
    var total=D.assets.filter(function(a){return a.qty>0}).reduce(function(s,a){return s+a.cost},0);
    $('assTotal').textContent=fmt(total);
    $('assList').innerHTML=D.assets.filter(function(a){return a.qty>0}).map(function(a){
        return'<div class="list-item"><div class="row"><div class="title">'+a.name+'</div><div><div class="amount yellow">'+a.qty+' —à—Ç</div><div class="sub">'+fmt(a.cost)+'</div></div></div></div>'
    }).join('')||'<div class="empty"><span>üì¶</span>–ü—É—Å—Ç–æ</div>';
}

// –ü–†–û–ï–ö–¢–´
function newProj(){
    $('projId').value='';$('projTitle').textContent='–ù–æ–≤—ã–π –ø—Ä–æ–µ–∫—Ç';
    $('projName').value='';$('projClient').value='';$('projPhone').value='';$('projAddr').value='';$('projSum').value='';
    showModal('project');
}
function editProj(id){
    var p=D.projects.find(function(x){return x.id===id});if(!p)return;
    $('projId').value=id;$('projTitle').textContent='–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å';
    $('projName').value=p.name||'';$('projClient').value=p.client||'';$('projPhone').value=p.phone||'';$('projAddr').value=p.address||'';$('projSum').value=p.sum||'';
    showModal('project');
}
async function saveProj(){
    var id=$('projId').value;
    var name=$('projName').value.trim();
    var sum=parseFloat($('projSum').value)||0;
    if(!name)return toast('‚ùå –í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ');
    if(id){
        var p=D.projects.find(function(x){return x.id===id});
        if(p){p.name=name;p.client=$('projClient').value;p.phone=$('projPhone').value;p.address=$('projAddr').value;p.sum=sum;p.ts=now()}
    }else{
        D.projects.push({id:'P'+Date.now(),name:name,client:$('projClient').value,phone:$('projPhone').value,address:$('projAddr').value,sum:sum,paid:0,status:'active',stage:0,ts:now()});
    }
    if(await saveCloud()){hideModal('project');render();toast('‚úÖ')}
}
async function projStatus(id,s){var p=D.projects.find(function(x){return x.id===id});if(p){p.status=s;p._deleted=false;p.ts=now();if(await saveCloud()){render();toast('‚úÖ')}}}
async function delProj(id){if(!confirm('–£–¥–∞–ª–∏—Ç—å?'))return;var p=D.projects.find(function(x){return x.id===id});if(p){p._deleted=true;p.ts=now();if(await saveCloud()){render();toast('üóë')}}}
async function restoreProj(id){var p=D.projects.find(function(x){return x.id===id});if(p){p._deleted=false;p.status='active';p.ts=now();if(await saveCloud()){render();toast('‚ôªÔ∏è')}}}

// –î–û–•–û–î–´
async function addInc(){
    var projId=$('iProj').value;
    var sum=parseFloat($('iSum').value)||0;
    var type=$('iType').value;
    var author=$('iAuthor').value;
    if(!sum)return toast('‚ùå');
    D.income.push({id:'I'+Date.now(),projectId:projId,amount:sum,type:type,author:author,date:today(),ts:now()});
    if(await saveCloud()){$('iSum').value='';render();toast('‚úÖ')}
}
function editInc(id){
    var i=D.income.find(function(x){return x.id===id});if(!i)return;
    renderSelects();
    $('eiId').value=id;$('eiProj').value=i.projectId||'';$('eiSum').value=i.amount;$('eiType').value=i.type||'–ü—Ä–µ–¥–æ–ø–ª–∞—Ç–∞';
    showModal('editInc');
}
async function saveInc(){
    var id=$('eiId').value;
    var i=D.income.find(function(x){return x.id===id});if(!i)return;
    i.projectId=$('eiProj').value;i.amount=parseFloat($('eiSum').value)||0;i.type=$('eiType').value;i.ts=now();
    if(await saveCloud()){hideModal('editInc');render();toast('‚úÖ')}
}
async function archiveInc(id){var i=D.income.find(function(x){return x.id===id});if(i){i._archived=true;i.ts=now();if(await saveCloud()){render();toast('üì¶')}}}
async function delInc(id){if(!confirm('–£–¥–∞–ª–∏—Ç—å?'))return;var i=D.income.find(function(x){return x.id===id});if(i){i._deleted=true;i.ts=now();if(await saveCloud()){render();toast('üóë')}}}
async function restoreInc(id){var i=D.income.find(function(x){return x.id===id});if(i){i._archived=false;i._deleted=false;i.ts=now();if(await saveCloud()){render();toast('‚ôªÔ∏è')}}}

// –†–ê–°–•–û–î–´
async function addExp(){
    var projId=$('eProj').value;
    var cat=$('eCat').value;
    var sum=parseFloat($('eSum').value)||0;
    var desc=$('eDesc').value;
    var author=$('eAuthor').value;
    if(!sum)return toast('‚ùå');
    D.expenses.push({id:'E'+Date.now(),projectId:projId,category:cat,amount:sum,desc:desc,author:author,date:today(),ts:now()});
    if(await saveCloud()){$('eSum').value='';$('eDesc').value='';render();toast('‚úÖ')}
}
function editExp(id){
    var e=D.expenses.find(function(x){return x.id===id});if(!e)return;
    renderSelects();
    $('eeId').value=id;$('eeProj').value=e.projectId||'–û–±—â–∏–µ';$('eeCat').value=e.category||'–ú–∞–≥–∞–∑–∏–Ω—ã';$('eeSum').value=e.amount;$('eeDesc').value=e.desc||'';
    showModal('editExp');
}
async function saveExp(){
    var id=$('eeId').value;
    var e=D.expenses.find(function(x){return x.id===id});if(!e)return;
    e.projectId=$('eeProj').value;e.category=$('eeCat').value;e.amount=parseFloat($('eeSum').value)||0;e.desc=$('eeDesc').value;e.ts=now();
    if(await saveCloud()){hideModal('editExp');render();toast('‚úÖ')}
}
async function archiveExp(id){var e=D.expenses.find(function(x){return x.id===id});if(e){e._archived=true;e.ts=now();if(await saveCloud()){render();toast('üì¶')}}}
async function delExp(id){if(!confirm('–£–¥–∞–ª–∏—Ç—å?'))return;var e=D.expenses.find(function(x){return x.id===id});if(e){e._deleted=true;e.ts=now();if(await saveCloud()){render();toast('üóë')}}}
async function restoreExp(id){var e=D.expenses.find(function(x){return x.id===id});if(e){e._archived=false;e._deleted=false;e.ts=now();if(await saveCloud()){render();toast('‚ôªÔ∏è')}}}

// –°–ö–õ–ê–î
async function addAsset(){
    var name=$('assName').value.trim();
    var qty=parseFloat($('assQty').value)||0;
    var cost=parseFloat($('assCost').value)||0;
    if(!name||!qty||!cost)return toast('‚ùå');
    D.assets.push({id:'A'+Date.now(),name:name,qty:qty,cost:cost,ts:now()});
    if(await saveCloud()){hideModal('addAsset');$('assName').value='';$('assQty').value='';$('assCost').value='';render();toast('‚úÖ')}
}

function backup(){
    var a=document.createElement('a');
    a.href=URL.createObjectURL(new Blob([JSON.stringify(D,null,2)],{type:'application/json'}));
    a.download='backup_'+today()+'.json';a.click();toast('üíæ');
}

// –°–¢–ê–†–¢
loadLocal();fix();render();loadCloud();setInterval(loadCloud,10000);
</script>
</body>
</html>
